---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getUbikalaPropertyById } from '../../../lib/ubikala-db';

const user = Astro.locals.user;
const { id } = Astro.params;

const property = await getUbikalaPropertyById(id!);

if (!property) {
  return Astro.redirect('/admin/properties');
}

// Check permissions
if (user?.role !== 'admin' && property.created_by !== user?.id) {
  return Astro.redirect('/admin/properties');
}
---

<AdminLayout title={`Editar: ${property.titulo}`}>
  <div class="edit-property-page">
    <div class="page-header">
      <a href="/admin/properties" class="back-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6" />
        </svg>
        Volver a propiedades
      </a>
      <h3>Editar Propiedad</h3>
    </div>

    <form id="property-form" class="property-form">
      <input type="hidden" id="property-id" value={id} />

      <div class="form-section">
        <h4>Información Básica</h4>
        <div class="form-grid">
          <div class="form-group full-width">
            <label for="titulo">Título *</label>
            <input type="text" id="titulo" name="titulo" required value={property.titulo} />
          </div>
          <div class="form-group">
            <label for="tipo">Tipo de Propiedad *</label>
            <select id="tipo" name="tipo" required>
              <option value="casa" selected={property.tipo === 'casa'}>Casa</option>
              <option value="apartamento" selected={property.tipo === 'apartamento'}>Apartamento</option>
              <option value="villa" selected={property.tipo === 'villa'}>Villa</option>
              <option value="terreno" selected={property.tipo === 'terreno'}>Terreno</option>
              <option value="local" selected={property.tipo === 'local'}>Local Comercial</option>
              <option value="oficina" selected={property.tipo === 'oficina'}>Oficina</option>
            </select>
          </div>
          <div class="form-group">
            <label for="operacion">Operación *</label>
            <select id="operacion" name="operacion" required>
              <option value="venta" selected={property.operacion === 'venta'}>Venta</option>
              <option value="alquiler" selected={property.operacion === 'alquiler'}>Alquiler</option>
            </select>
          </div>
          <div class="form-group">
            <label for="estado">Estado</label>
            <select id="estado" name="estado">
              <option value="disponible" selected={property.estado === 'disponible'}>Disponible</option>
              <option value="reservada" selected={property.estado === 'reservada'}>Reservada</option>
              <option value="vendida" selected={property.estado === 'vendida'}>Vendida</option>
              <option value="alquilada" selected={property.estado === 'alquilada'}>Alquilada</option>
            </select>
          </div>
          <div class="form-group">
            <label for="codigo">Código</label>
            <input type="text" id="codigo" name="codigo" value={property.codigo || ''} />
          </div>
          <div class="form-group full-width">
            <label for="descripcion">Descripción</label>
            <textarea id="descripcion" name="descripcion" rows="4">{property.descripcion || ''}</textarea>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h4>Precio</h4>
        <div class="form-grid">
          <div class="form-group">
            <label for="precio">Precio *</label>
            <input type="number" id="precio" name="precio" required min="0" step="0.01" value={property.precio} />
          </div>
          <div class="form-group">
            <label for="moneda">Moneda</label>
            <select id="moneda" name="moneda">
              <option value="USD" selected={property.moneda === 'USD'}>USD</option>
              <option value="DOP" selected={property.moneda === 'DOP'}>DOP</option>
              <option value="EUR" selected={property.moneda === 'EUR'}>EUR</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h4>Ubicación</h4>
        <div class="form-grid">
          <div class="form-group">
            <label for="provincia">Provincia</label>
            <input type="text" id="provincia" name="provincia" value={property.provincia || ''} />
          </div>
          <div class="form-group">
            <label for="ciudad">Ciudad</label>
            <input type="text" id="ciudad" name="ciudad" value={property.ciudad || ''} />
          </div>
          <div class="form-group">
            <label for="sector">Sector</label>
            <input type="text" id="sector" name="sector" value={property.sector || ''} />
          </div>
          <div class="form-group full-width">
            <label for="direccion">Dirección</label>
            <input type="text" id="direccion" name="direccion" value={property.direccion || ''} />
          </div>
          <div class="form-group">
            <label for="latitud">Latitud</label>
            <input type="number" id="latitud" name="latitud" step="0.0000001" value={property.latitud || ''} />
          </div>
          <div class="form-group">
            <label for="longitud">Longitud</label>
            <input type="number" id="longitud" name="longitud" step="0.0000001" value={property.longitud || ''} />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h4>Características</h4>
        <div class="form-grid">
          <div class="form-group">
            <label for="habitaciones">Habitaciones</label>
            <input type="number" id="habitaciones" name="habitaciones" min="0" value={property.habitaciones || ''} />
          </div>
          <div class="form-group">
            <label for="banos">Baños</label>
            <input type="number" id="banos" name="banos" min="0" value={property.banos || ''} />
          </div>
          <div class="form-group">
            <label for="medios_banos">Medios Baños</label>
            <input type="number" id="medios_banos" name="medios_banos" min="0" value={property.medios_banos || ''} />
          </div>
          <div class="form-group">
            <label for="estacionamientos">Estacionamientos</label>
            <input type="number" id="estacionamientos" name="estacionamientos" min="0" value={property.estacionamientos || ''} />
          </div>
          <div class="form-group">
            <label for="m2_construccion">m² Construcción</label>
            <input type="number" id="m2_construccion" name="m2_construccion" min="0" step="0.01" value={property.m2_construccion || ''} />
          </div>
          <div class="form-group">
            <label for="m2_terreno">m² Terreno</label>
            <input type="number" id="m2_terreno" name="m2_terreno" min="0" step="0.01" value={property.m2_terreno || ''} />
          </div>
          <div class="form-group">
            <label for="pisos">Pisos</label>
            <input type="number" id="pisos" name="pisos" min="0" value={property.pisos || ''} />
          </div>
          <div class="form-group">
            <label for="ano_construccion">Año de Construcción</label>
            <input type="number" id="ano_construccion" name="ano_construccion" min="1900" max="2030" value={property.ano_construccion || ''} />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h4>Media</h4>
        <div class="form-grid">
          <div class="form-group full-width">
            <label for="imagen_principal">URL Imagen Principal</label>
            <input type="url" id="imagen_principal" name="imagen_principal" value={property.imagen_principal || ''} />
          </div>
          <div class="form-group full-width">
            <label for="video_url">URL Video</label>
            <input type="url" id="video_url" name="video_url" value={property.video_url || ''} />
          </div>
          <div class="form-group full-width">
            <label for="tour_virtual_url">URL Tour Virtual</label>
            <input type="url" id="tour_virtual_url" name="tour_virtual_url" value={property.tour_virtual_url || ''} />
          </div>
        </div>
        {property.imagen_principal && (
          <div class="image-preview">
            <img src={property.imagen_principal} alt={property.titulo} />
          </div>
        )}
      </div>

      <div class="form-section">
        <h4>Opciones</h4>
        <div class="checkbox-grid">
          <label class="checkbox-label">
            <input type="checkbox" id="activo" name="activo" checked={property.activo} />
            <span>Propiedad activa</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="destacada" name="destacada" checked={property.destacada} />
            <span>Propiedad destacada</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="exclusiva" name="exclusiva" checked={property.exclusiva} />
            <span>Propiedad exclusiva</span>
          </label>
        </div>
      </div>

      <div id="form-error" class="form-error hidden"></div>

      <div class="form-actions">
        <a href="/admin/properties" class="btn-secondary">Cancelar</a>
        <button type="submit" class="btn-primary" id="submit-btn">Guardar Cambios</button>
      </div>
    </form>
  </div>

  <style>
    .edit-property-page {
      max-width: 900px;
    }
    .page-header {
      margin-bottom: 1.5rem;
    }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      color: #6b7280;
      text-decoration: none;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
    }
    .back-link:hover {
      color: #374151;
    }
    .back-link svg {
      width: 16px;
      height: 16px;
    }
    .page-header h3 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #111827;
    }
    .property-form {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .form-section {
      padding: 1.5rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .form-section:last-of-type {
      border-bottom: none;
    }
    .form-section h4 {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 1rem;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    .form-group label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 0.625rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }
    .form-group textarea {
      resize: vertical;
    }
    .image-preview {
      margin-top: 1rem;
      border-radius: 0.5rem;
      overflow: hidden;
      max-width: 300px;
    }
    .image-preview img {
      width: 100%;
      height: auto;
    }
    .checkbox-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: 0.875rem;
      color: #374151;
    }
    .checkbox-label input {
      width: 1rem;
      height: 1rem;
    }
    .form-error {
      margin: 1rem 1.5rem;
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }
    .form-error.hidden {
      display: none;
    }
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      padding: 1.5rem;
      background: #f9fafb;
      border-radius: 0 0 0.75rem 0.75rem;
    }
    .btn-primary,
    .btn-secondary {
      padding: 0.625rem 1.25rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      border: none;
    }
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    .btn-primary:hover {
      background: #2563eb;
    }
    .btn-primary:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: white;
      color: #374151;
      border: 1px solid #d1d5db;
    }
    .btn-secondary:hover {
      background: #f3f4f6;
    }
    @media (max-width: 640px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <script>
    const form = document.getElementById('property-form') as HTMLFormElement;
    const formError = document.getElementById('form-error') as HTMLDivElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const propertyId = (document.getElementById('property-id') as HTMLInputElement).value;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      formError.classList.add('hidden');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Guardando...';

      const formData = new FormData(form);
      const data: any = {};

      // Text fields
      ['titulo', 'tipo', 'operacion', 'estado', 'codigo', 'descripcion', 'moneda',
       'provincia', 'ciudad', 'sector', 'direccion', 'imagen_principal', 'video_url', 'tour_virtual_url'
      ].forEach(field => {
        const value = formData.get(field);
        if (value) data[field] = value;
      });

      // Number fields
      ['precio', 'habitaciones', 'banos', 'medios_banos', 'estacionamientos',
       'm2_construccion', 'm2_terreno', 'pisos', 'ano_construccion', 'latitud', 'longitud'
      ].forEach(field => {
        const value = formData.get(field);
        if (value) data[field] = parseFloat(value as string);
      });

      // Boolean fields
      data.activo = (document.getElementById('activo') as HTMLInputElement).checked;
      data.destacada = (document.getElementById('destacada') as HTMLInputElement).checked;
      data.exclusiva = (document.getElementById('exclusiva') as HTMLInputElement).checked;

      try {
        const response = await fetch(`/api/admin/properties/${propertyId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Error al actualizar propiedad');
        }

        window.location.href = '/admin/properties';
      } catch (error: any) {
        formError.textContent = error.message;
        formError.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Guardar Cambios';
      }
    });
  </script>
</AdminLayout>
