---
import Layout from '../../layouts/Layout.astro';
import PropertyCard from '../../components/PropertyCard.astro';
import Pagination from '../../components/Pagination.astro';
import Icon from '../../components/Icons.astro';
import { useTranslations, getAlternateUrls } from '../../i18n';
import { searchProperties } from '../../lib/meilisearch';
import type { Property } from '../../data/types';

// SSR for dynamic search
export const prerender = false;

const t = useTranslations('en');
const alternateUrls = getAlternateUrls('/en/search');

const ITEMS_PER_PAGE = 24;
const currentPage = Math.max(1, parseInt(Astro.url.searchParams.get('page') || '1'));

const params = Astro.url.searchParams;

const typeToDb: Record<string, string> = {
  'house': 'casa',
  'apartment': 'apartamento',
  'villa': 'villa',
  'penthouse': 'penthouse',
  'land': 'terreno',
  'commercial': 'local',
  'office': 'oficina',
};

const filters = {
  query: params.get('q') || undefined,
  transactionType: (params.get('transactionType') as 'sale' | 'rent' | 'all') || 'all',
  propertyType: params.get('propertyType') || 'all',
  location: params.get('location') || undefined,
  minPrice: params.get('minPrice') ? parseInt(params.get('minPrice')!) : undefined,
  maxPrice: params.get('maxPrice') ? parseInt(params.get('maxPrice')!) : undefined,
  bedrooms: params.get('bedrooms') ? parseInt(params.get('bedrooms')!) : undefined,
  bathrooms: params.get('bathrooms') ? parseInt(params.get('bathrooms')!) : undefined,
  tenantId: params.get('tenant_id') || undefined,
};

let results: Property[] = [];
let totalCount = 0;

try {
  const offset = (currentPage - 1) * ITEMS_PER_PAGE;

  const operacion = filters.transactionType === 'sale' ? 'venta'
    : filters.transactionType === 'rent' ? 'renta' : undefined;

  const tipo = (filters.propertyType && filters.propertyType !== 'all')
    ? (typeToDb[filters.propertyType] || filters.propertyType)
    : undefined;

  const searchResult = await searchProperties({
    query: filters.query || filters.location || '',
    tipo,
    operacion,
    precioMin: filters.minPrice,
    precioMax: filters.maxPrice,
    habitacionesMin: filters.bedrooms,
    banosMin: filters.bathrooms,
    tenantId: filters.tenantId,
    limit: ITEMS_PER_PAGE,
    offset,
    lang: 'en',
  });

  results = searchResult.properties;
  totalCount = searchResult.total;
} catch (error) {
  console.error('Error searching properties:', error);
}

const totalPages = Math.ceil(totalCount / ITEMS_PER_PAGE);

// Preserve search params for pagination
const preserveParams: Record<string, string> = {};
if (filters.query) preserveParams.q = filters.query;
if (filters.transactionType !== 'all') preserveParams.transactionType = filters.transactionType;
if (filters.propertyType !== 'all') preserveParams.propertyType = filters.propertyType;
if (filters.location) preserveParams.location = filters.location;
if (filters.minPrice) preserveParams.minPrice = String(filters.minPrice);
if (filters.maxPrice) preserveParams.maxPrice = String(filters.maxPrice);
if (filters.bedrooms) preserveParams.bedrooms = String(filters.bedrooms);
if (filters.tenantId) preserveParams.tenant_id = filters.tenantId;

// Dynamic title
let pageTitle = 'Search Properties';
if (filters.location) {
  pageTitle = `Properties in ${filters.location}`;
}
if (filters.propertyType && filters.propertyType !== 'all') {
  const typeNames: Record<string, string> = {
    house: 'Houses', apartment: 'Apartments', villa: 'Villas',
    penthouse: 'Penthouses', land: 'Land', commercial: 'Commercial', office: 'Offices',
  };
  pageTitle = typeNames[filters.propertyType] || pageTitle;
  if (filters.location) pageTitle += ` in ${filters.location}`;
}

const fullTitle = `${pageTitle} | Ub√≠kala`;
const description = `Find ${totalCount} properties available. Search houses, apartments, villas and more in the Dominican Republic.`;
---

<Layout
  title={fullTitle}
  description={description}
  alternateLanguages={alternateUrls}
>
  <!-- Sticky Filter Bar -->
  <div class="sticky top-16 z-40 bg-white border-b shadow-sm">
    <div class="container-custom py-3">
      <div class="flex flex-col sm:flex-row sm:items-center gap-3">
        <nav class="text-sm text-gray-500 hidden md:flex items-center">
          <a href="/en" class="hover:text-primary-600">{t.nav.home}</a>
          <span class="mx-1">/</span>
          <span class="text-gray-900">{pageTitle}</span>
        </nav>

        <form action="/en/search" method="GET" class="flex flex-1 items-center gap-2 sm:justify-end">
          {filters.tenantId && <input type="hidden" name="tenant_id" value={filters.tenantId} />}
          <select name="transactionType" class="select py-1.5 px-3 text-sm w-auto" onchange="this.form.submit()">
            <option value="all" selected={filters.transactionType === 'all'}>Transaction</option>
            <option value="sale" selected={filters.transactionType === 'sale'}>For Sale</option>
            <option value="rent" selected={filters.transactionType === 'rent'}>For Rent</option>
          </select>
          <select name="propertyType" class="select py-1.5 px-3 text-sm w-auto" onchange="this.form.submit()">
            <option value="all" selected={filters.propertyType === 'all'}>Type</option>
            <option value="house" selected={filters.propertyType === 'house'}>House</option>
            <option value="apartment" selected={filters.propertyType === 'apartment'}>Apartment</option>
            <option value="villa" selected={filters.propertyType === 'villa'}>Villa</option>
            <option value="land" selected={filters.propertyType === 'land'}>Land</option>
          </select>
          <select name="location" class="select py-1.5 px-3 text-sm w-auto hidden sm:block" onchange="this.form.submit()">
            <option value="">Location</option>
            <option value="santo-domingo" selected={filters.location === 'santo-domingo'}>Santo Domingo</option>
            <option value="punta-cana" selected={filters.location === 'punta-cana'}>Punta Cana</option>
            <option value="santiago" selected={filters.location === 'santiago'}>Santiago</option>
          </select>
          <noscript><button type="submit" class="btn-primary py-1.5 px-3 text-sm">Filter</button></noscript>
        </form>
      </div>
    </div>
  </div>

  <!-- Page Header -->
  <div class="bg-gray-50 py-6">
    <div class="container-custom">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900">{pageTitle}</h1>
      <p class="text-gray-600 mt-1">
        {totalCount} {totalCount === 1 ? 'property available' : 'properties available'} in the Dominican Republic
      </p>
    </div>
  </div>

  <!-- Results -->
  <section class="py-8">
    <div class="container-custom">
      <div class="flex items-center justify-between mb-6">
        <div class="flex flex-wrap items-center gap-2">
          {filters.transactionType !== 'all' && (
            <span class="badge-primary flex items-center gap-1">
              {filters.transactionType === 'sale' ? 'For Sale' : 'For Rent'}
            </span>
          )}
          {filters.propertyType !== 'all' && (
            <span class="badge-secondary flex items-center gap-1">
              {filters.propertyType}
            </span>
          )}
          {filters.location && (
            <span class="badge bg-gray-200 text-gray-700 flex items-center gap-1">
              {filters.location}
            </span>
          )}
        </div>

        <select id="sort" class="select py-1.5 px-3 text-sm w-auto">
          <option value="recent">Most Recent</option>
          <option value="price-asc">Price: Low to High</option>
          <option value="price-desc">Price: High to Low</option>
        </select>
      </div>

      {results.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {results.map((property) => (
            <PropertyCard property={property} />
          ))}
        </div>
      ) : (
        <div class="card p-12 text-center">
          <Icon name="search" class="w-16 h-16 text-gray-300 mx-auto mb-4" />
          <h2 class="text-2xl font-semibold text-gray-900 mb-2">
            No properties found
          </h2>
          <p class="text-gray-600 mb-6 max-w-md mx-auto">
            Try adjusting your search filters or explore other locations.
          </p>
          <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="/en/buy" class="btn-primary">
              View all for sale
            </a>
            <a href="/en/rent" class="btn-outline">
              View all for rent
            </a>
          </div>
        </div>
      )}

      {results.length > 0 && (
        <div class="mt-12">
          <Pagination
            currentPage={currentPage}
            totalPages={totalPages}
            baseUrl="/en/search"
            preserveParams={preserveParams}
          />
        </div>
      )}
    </div>
  </section>
</Layout>
