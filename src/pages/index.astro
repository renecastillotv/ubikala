---
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import FeaturedProperties from '../components/FeaturedProperties.astro';
import LocationsGrid from '../components/LocationsGrid.astro';
import CTASection from '../components/CTASection.astro';
import AgentCard from '../components/AgentCard.astro';
import { useTranslations } from '../i18n';
import { getAgents } from '../lib/db';
import { getUbikalaAgents } from '../lib/ubikala-db';
import { transformAgents, transformUbikalaAgents, type DBAgent } from '../lib/transformers';
import type { Agent } from '../data/types';

const t = useTranslations('es');

// Fetch agents from both databases and merge
let featuredAgents: Agent[] = [];
try {
  const [dbAgents, ubikalaAgentRows] = await Promise.all([
    getAgents({ limit: 4 }),
    getUbikalaAgents({ limit: 4 })
  ]);
  const clicAgents = transformAgents(dbAgents as unknown as DBAgent[]);
  const ubikalaAgents = transformUbikalaAgents(ubikalaAgentRows);
  // Merge and sort by properties count, take top 4
  featuredAgents = [...clicAgents, ...ubikalaAgents]
    .sort((a, b) => b.propertiesCount - a.propertiesCount)
    .slice(0, 4);
} catch (error) {
  console.error('Error fetching agents:', error);
}

// SEO Schema para la página principal
const homeSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: 'Ubikala',
  url: 'https://ubikala.com',
  description: t.meta.siteDescription,
  potentialAction: {
    '@type': 'SearchAction',
    target: {
      '@type': 'EntryPoint',
      urlTemplate: 'https://ubikala.com/buscar?q={search_term_string}'
    },
    'query-input': 'required name=search_term_string'
  }
};

// Organization schema
const organizationSchema = {
  '@context': 'https://schema.org',
  '@type': 'RealEstateAgent',
  name: 'Ubikala',
  url: 'https://ubikala.com',
  logo: 'https://ubikala.com/logo.png',
  description: 'Esa propiedad que buscas, ubíkala aquí. Encuentra casas, apartamentos, villas y terrenos en venta y alquiler en República Dominicana.',
  address: {
    '@type': 'PostalAddress',
    addressCountry: 'DO',
    addressRegion: 'República Dominicana'
  },
  areaServed: {
    '@type': 'Country',
    name: 'República Dominicana'
  },
  sameAs: [
    'https://www.facebook.com/ubikala',
    'https://www.instagram.com/ubikala',
    'https://linkedin.com/company/ubikala'
  ]
};
---

<Layout
  title={t.pages.home.title}
  description={t.pages.home.description}
  keywords={t.meta.keywords}
>
  <script is:inline type="application/ld+json" set:html={JSON.stringify(homeSchema)} slot="head" />
  <script is:inline type="application/ld+json" set:html={JSON.stringify(organizationSchema)} slot="head" />

  <!-- Hero with Search -->
  <Hero />

  <!-- Featured Properties -->
  <FeaturedProperties />

  <!-- Locations Grid -->
  <LocationsGrid />

  <!-- Property Types Section -->
  <section class="section bg-gray-50">
    <div class="container-custom">
      <div class="text-center mb-12">
        <span class="text-primary-600 font-semibold text-sm uppercase tracking-wider">
          {t.sections.propertyTypes}
        </span>
        <h2 class="section-title mt-2">
          {t.sections.propertyTypesTitle}
        </h2>
        <p class="section-subtitle mx-auto">
          {t.sections.propertyTypesDesc}
        </p>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        <a href="/comprar/casas" class="card p-6 text-center group hover:bg-primary-50 transition-colors">
          <div class="w-14 h-14 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-primary-200 transition-colors">
            <svg class="w-7 h-7 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
          </div>
          <h3 class="font-semibold text-gray-900">{t.propertyTypes.house}</h3>
        </a>

        <a href="/comprar/apartamentos" class="card p-6 text-center group hover:bg-primary-50 transition-colors">
          <div class="w-14 h-14 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-primary-200 transition-colors">
            <svg class="w-7 h-7 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
          </div>
          <h3 class="font-semibold text-gray-900">{t.propertyTypes.apartment}</h3>
        </a>

        <a href="/comprar/villas" class="card p-6 text-center group hover:bg-primary-50 transition-colors">
          <div class="w-14 h-14 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-primary-200 transition-colors">
            <svg class="w-7 h-7 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
            </svg>
          </div>
          <h3 class="font-semibold text-gray-900">{t.propertyTypes.villa}</h3>
        </a>

        <a href="/comprar/penthouses" class="card p-6 text-center group hover:bg-primary-50 transition-colors">
          <div class="w-14 h-14 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-primary-200 transition-colors">
            <svg class="w-7 h-7 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
            </svg>
          </div>
          <h3 class="font-semibold text-gray-900">{t.propertyTypes.penthouse}</h3>
        </a>

        <a href="/comprar/terrenos" class="card p-6 text-center group hover:bg-primary-50 transition-colors">
          <div class="w-14 h-14 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-primary-200 transition-colors">
            <svg class="w-7 h-7 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
            </svg>
          </div>
          <h3 class="font-semibold text-gray-900">{t.propertyTypes.land}</h3>
        </a>

        <a href="/comprar/locales-comerciales" class="card p-6 text-center group hover:bg-primary-50 transition-colors">
          <div class="w-14 h-14 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-primary-200 transition-colors">
            <svg class="w-7 h-7 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
          </div>
          <h3 class="font-semibold text-gray-900">{t.propertyTypes.commercial}</h3>
        </a>
      </div>
    </div>
  </section>

  <!-- Featured Agents -->
  <section class="section">
    <div class="container-custom">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between mb-12">
        <div>
          <span class="text-primary-600 font-semibold text-sm uppercase tracking-wider">
            {t.sections.verifiedAgents}
          </span>
          <h2 class="section-title mt-2">
            {t.sections.meetOurExperts}
          </h2>
          <p class="section-subtitle">
            {t.sections.expertsDesc}
          </p>
        </div>
        <a href="/asesores" class="btn-outline mt-6 md:mt-0">
          {t.sections.viewAllAgents}
          <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
          </svg>
        </a>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {featuredAgents.map((agent) => (
          <AgentCard agent={agent} />
        ))}
      </div>
    </div>
  </section>

  <!-- Why Choose Us -->
  <section class="section bg-gray-50">
    <div class="container-custom">
      <div class="text-center mb-12">
        <span class="text-primary-600 font-semibold text-sm uppercase tracking-wider">
          {t.sections.whyChooseUs}
        </span>
        <h2 class="section-title mt-2">
          {t.sections.portalTitle}
        </h2>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="text-center">
          <div class="w-20 h-20 bg-primary-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
            <svg class="w-10 h-10 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-gray-900 mb-3">{t.sections.smartSearch}</h3>
          <p class="text-gray-600">
            {t.sections.smartSearchDesc}
          </p>
        </div>

        <div class="text-center">
          <div class="w-20 h-20 bg-secondary-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
            <svg class="w-10 h-10 text-secondary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-gray-900 mb-3">{t.sections.verifiedProperties}</h3>
          <p class="text-gray-600">
            {t.sections.verifiedPropertiesDesc}
          </p>
        </div>

        <div class="text-center">
          <div class="w-20 h-20 bg-accent-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
            <svg class="w-10 h-10 text-accent-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-gray-900 mb-3">{t.sections.expertAgents}</h3>
          <p class="text-gray-600">
            {t.sections.expertAgentsDesc}
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <CTASection />
</Layout>
