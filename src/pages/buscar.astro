---
import Layout from '../layouts/Layout.astro';
import PropertyCard from '../components/PropertyCard.astro';
import Pagination from '../components/Pagination.astro';
import Icon from '../components/Icons.astro';
import { useTranslations } from '../i18n';
import { searchProperties } from '../lib/meilisearch';
import type { Property } from '../data/types';
import { firstTimeBuyerFAQs, financingFAQs, usBuyerFAQs } from '../lib/seo-content';

// SSR para búsqueda dinámica
export const prerender = false;

const t = useTranslations('es');

// Configuración de paginación
const ITEMS_PER_PAGE = 24;
const currentPage = Math.max(1, parseInt(Astro.url.searchParams.get('page') || '1'));

// Obtener parámetros de búsqueda de la URL
const url = Astro.url;
const params = url.searchParams;

// Mapeo de tipos de propiedad frontend a DB
const typeToDb: Record<string, string> = {
  'house': 'casa',
  'apartment': 'apartamento',
  'villa': 'villa',
  'penthouse': 'penthouse',
  'land': 'terreno',
  'commercial': 'local',
  'office': 'oficina',
};

const filters = {
  query: params.get('q') || undefined,
  transactionType: (params.get('transactionType') as 'sale' | 'rent' | 'all') || 'all',
  propertyType: params.get('propertyType') || 'all',
  location: params.get('location') || undefined,
  minPrice: params.get('minPrice') ? parseInt(params.get('minPrice')!) : undefined,
  maxPrice: params.get('maxPrice') ? parseInt(params.get('maxPrice')!) : undefined,
  bedrooms: params.get('bedrooms') ? parseInt(params.get('bedrooms')!) : undefined,
  bathrooms: params.get('bathrooms') ? parseInt(params.get('bathrooms')!) : undefined,
};

// Buscar propiedades via MeiliSearch
let results: Property[] = [];
let totalCount = 0;

try {
  const offset = (currentPage - 1) * ITEMS_PER_PAGE;

  const operacion = filters.transactionType === 'sale' ? 'venta'
    : filters.transactionType === 'rent' ? 'renta' : undefined;

  const tipo = (filters.propertyType && filters.propertyType !== 'all')
    ? (typeToDb[filters.propertyType] || filters.propertyType)
    : undefined;

  const searchResult = await searchProperties({
    query: filters.query || filters.location || '',
    tipo,
    operacion,
    precioMin: filters.minPrice,
    precioMax: filters.maxPrice,
    habitacionesMin: filters.bedrooms,
    banosMin: filters.bathrooms,
    limit: ITEMS_PER_PAGE,
    offset,
  });

  results = searchResult.properties;
  totalCount = searchResult.total;
} catch (error) {
  console.error('Error searching properties:', error);
}

const totalPages = Math.ceil(totalCount / ITEMS_PER_PAGE);

// Preserve search params for pagination
const preserveParams: Record<string, string> = {};
if (filters.query) preserveParams.q = filters.query;
if (filters.transactionType !== 'all') preserveParams.transactionType = filters.transactionType;
if (filters.propertyType !== 'all') preserveParams.propertyType = filters.propertyType;
if (filters.location) preserveParams.location = filters.location;
if (filters.minPrice) preserveParams.minPrice = String(filters.minPrice);
if (filters.maxPrice) preserveParams.maxPrice = String(filters.maxPrice);
if (filters.bedrooms) preserveParams.bedrooms = String(filters.bedrooms);

// Generar título dinámico
let pageTitle = 'Buscar Propiedades';
if (filters.location) {
  pageTitle = `Propiedades en ${filters.location}`;
}
if (filters.propertyType && filters.propertyType !== 'all') {
  const typeNames: Record<string, string> = {
    house: 'Casas',
    apartment: 'Apartamentos',
    villa: 'Villas',
    penthouse: 'Penthouses',
    land: 'Terrenos',
    commercial: 'Locales Comerciales',
    office: 'Oficinas',
  };
  pageTitle = typeNames[filters.propertyType] || pageTitle;
  if (filters.location) {
    pageTitle += ` en ${filters.location}`;
  }
}

const fullTitle = `${pageTitle} | PropiedadEnRD.com`;
const description = `Encuentra ${totalCount} propiedades disponibles. Busca casas, apartamentos, villas y más en República Dominicana.`;
---

<Layout
  title={fullTitle}
  description={description}
>
  <!-- Sticky Filter Bar -->
  <div class="sticky top-16 z-40 bg-white border-b shadow-sm">
    <div class="container-custom py-3">
      <div class="flex flex-col sm:flex-row sm:items-center gap-3">
        <!-- Breadcrumb inline -->
        <nav class="text-sm text-gray-500 hidden md:flex items-center">
          <a href="/" class="hover:text-primary-600">Inicio</a>
          <span class="mx-1">/</span>
          <span class="text-gray-900">{pageTitle}</span>
        </nav>

        <!-- Filters inline -->
        <form action="/buscar" method="GET" class="flex flex-1 items-center gap-2 sm:justify-end">
          <select name="transactionType" class="select py-1.5 px-3 text-sm w-auto" onchange="this.form.submit()">
            <option value="all" selected={filters.transactionType === 'all'}>Operación</option>
            <option value="sale" selected={filters.transactionType === 'sale'}>Venta</option>
            <option value="rent" selected={filters.transactionType === 'rent'}>Alquiler</option>
          </select>
          <select name="propertyType" class="select py-1.5 px-3 text-sm w-auto" onchange="this.form.submit()">
            <option value="all" selected={filters.propertyType === 'all'}>Tipo</option>
            <option value="house" selected={filters.propertyType === 'house'}>Casa</option>
            <option value="apartment" selected={filters.propertyType === 'apartment'}>Apartamento</option>
            <option value="villa" selected={filters.propertyType === 'villa'}>Villa</option>
            <option value="land" selected={filters.propertyType === 'land'}>Terreno</option>
          </select>
          <select name="location" class="select py-1.5 px-3 text-sm w-auto hidden sm:block" onchange="this.form.submit()">
            <option value="">Ubicación</option>
            <option value="santo-domingo" selected={filters.location === 'santo-domingo'}>Santo Domingo</option>
            <option value="punta-cana" selected={filters.location === 'punta-cana'}>Punta Cana</option>
            <option value="santiago" selected={filters.location === 'santiago'}>Santiago</option>
          </select>
          <noscript><button type="submit" class="btn-primary py-1.5 px-3 text-sm">Filtrar</button></noscript>
        </form>
      </div>
    </div>
  </div>

  <!-- Page Header -->
  <div class="bg-gray-50 py-6">
    <div class="container-custom">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900">{pageTitle}</h1>
      <p class="text-gray-600 mt-1">
        {totalCount} {totalCount === 1 ? 'propiedad disponible' : 'propiedades disponibles'} en República Dominicana
      </p>
    </div>
  </div>

  <!-- Results -->
  <section class="py-8">
    <div class="container-custom">
      <!-- Results Header -->
      <div class="flex items-center justify-between mb-6">
        <!-- Active Filters -->
        <div class="flex flex-wrap items-center gap-2">
          {filters.transactionType !== 'all' && (
            <a href={`/buscar?propertyType=${filters.propertyType}&location=${filters.location || ''}`} class="badge-primary flex items-center gap-1">
              {filters.transactionType === 'sale' ? 'En Venta' : 'En Alquiler'}
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </a>
          )}
          {filters.propertyType !== 'all' && (
            <a href={`/buscar?transactionType=${filters.transactionType}&location=${filters.location || ''}`} class="badge-secondary flex items-center gap-1">
              {t.propertyTypes[filters.propertyType as keyof typeof t.propertyTypes] || filters.propertyType}
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </a>
          )}
          {filters.location && (
            <a href={`/buscar?transactionType=${filters.transactionType}&propertyType=${filters.propertyType}`} class="badge bg-gray-200 text-gray-700 flex items-center gap-1">
              {filters.location}
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </a>
          )}
        </div>

        <select id="sort" class="select py-1.5 px-3 text-sm w-auto">
          <option value="recent">Más recientes</option>
          <option value="price-asc">Menor precio</option>
          <option value="price-desc">Mayor precio</option>
        </select>
      </div>

      <!-- Results Grid -->
      {results.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {results.map((property) => (
            <PropertyCard property={property} />
          ))}
        </div>
      ) : (
        <div class="card p-12 text-center">
          <Icon name="search" class="w-16 h-16 text-gray-300 mx-auto mb-4" />
          <h2 class="text-2xl font-semibold text-gray-900 mb-2">
            No encontramos propiedades
          </h2>
          <p class="text-gray-600 mb-6 max-w-md mx-auto">
            Intenta ajustar tus filtros de búsqueda o explora otras ubicaciones.
          </p>
          <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="/comprar" class="btn-primary">
              Ver todas en venta
            </a>
            <a href="/alquilar" class="btn-outline">
              Ver todas en alquiler
            </a>
          </div>
        </div>
      )}

      <!-- Pagination -->
      {results.length > 0 && (
        <div class="mt-12">
          <Pagination
            currentPage={currentPage}
            totalPages={totalPages}
            baseUrl="/buscar"
            preserveParams={preserveParams}
          />
        </div>
      )}
    </div>
  </section>

  <!-- SEO Content - Dynamic based on filters -->
  <section class="py-12 bg-white">
    <div class="container-custom">
      <div class="prose prose-lg max-w-4xl mx-auto">
        {filters.location ? (
          <>
            <h2>Propiedades en {filters.location}, República Dominicana</h2>
            <p>
              Explora nuestra selección de {totalCount} propiedades disponibles en {filters.location}.
              Ya sea que busques una casa familiar, un apartamento moderno, una villa de lujo o un terreno
              para construir, en PropiedadEnRD.com encontrarás opciones verificadas por asesores inmobiliarios profesionales.
            </p>
            <p>
              {filters.location} es una de las zonas más buscadas de República Dominicana,
              conocida por su {filters.location.toLowerCase().includes('punta') ? 'cercanía a las playas y atractivo turístico' :
              filters.location.toLowerCase().includes('santiago') ? 'desarrollo comercial y calidad de vida' :
              'excelente ubicación y conectividad'}.
              Cada listado incluye fotos, descripción detallada y contacto directo con el asesor.
            </p>
          </>
        ) : filters.propertyType !== 'all' ? (
          <>
            <h2>{pageTitle} en República Dominicana</h2>
            <p>
              Descubre {totalCount} {pageTitle.toLowerCase()} disponibles en las mejores ubicaciones de República Dominicana.
              Nuestros asesores inmobiliarios verificados te ofrecen propiedades con información detallada,
              fotografías profesionales y asesoría personalizada.
            </p>
            <p>
              {filters.propertyType === 'house' ? 'Las casas en República Dominicana ofrecen espacios amplios, jardines y privacidad para tu familia.' :
               filters.propertyType === 'apartment' ? 'Los apartamentos son ideales para quienes buscan comodidad, seguridad y amenidades modernas.' :
               filters.propertyType === 'villa' ? 'Las villas de lujo combinan exclusividad, diseño arquitectónico y las mejores vistas del Caribe.' :
               filters.propertyType === 'land' ? 'Los terrenos representan una excelente oportunidad de inversión para construir tu proyecto ideal.' :
               'Encuentra la propiedad perfecta que se adapte a tus necesidades y presupuesto.'}
            </p>
          </>
        ) : (
          <>
            <h2>Buscar Propiedades en República Dominicana</h2>
            <p>
              En PropiedadEnRD.com, asesores inmobiliarios verificados y agencias publican sus propiedades
              para que puedas encontrar exactamente lo que buscas. Actualmente tenemos {totalCount} propiedades
              disponibles en todo el país.
            </p>
            <p>
              Usa los filtros de búsqueda para refinar los resultados por ubicación, precio, tipo de propiedad
              y características. Cada propiedad incluye información detallada, fotos de alta calidad y datos
              de contacto del asesor para que puedas comunicarte directamente y agendar una visita.
            </p>
          </>
        )}

        <h3>¿Por qué elegir PropiedadEnRD.com?</h3>
        <ul>
          <li><strong>Asesores verificados:</strong> Trabajamos solo con profesionales inmobiliarios certificados.</li>
          <li><strong>Información actualizada:</strong> Listados actualizados con precios y disponibilidad real.</li>
          <li><strong>Contacto directo:</strong> Comunícate directamente con el asesor de cada propiedad.</li>
          <li><strong>Búsqueda avanzada:</strong> Filtra por ubicación, precio, características y más.</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Educational Content & Internal Linking -->
  <section class="py-12 bg-gray-50">
    <div class="container-custom">
      <div class="grid md:grid-cols-3 gap-8">
        <!-- Bono Primera Vivienda -->
        <div class="bg-white rounded-xl p-6 shadow-sm">
          <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mb-4">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-gray-900 mb-2">Bono Primera Vivienda</h3>
          <p class="text-gray-600 text-sm mb-4">
            ¿Comprando tu primera casa? Podrías recibir hasta RD$1,500,000 de subsidio del gobierno.
          </p>
          <a href="/guias/bono-primera-vivienda" class="text-primary-600 font-medium text-sm hover:underline">
            Conoce los requisitos →
          </a>
        </div>

        <!-- Fideicomiso -->
        <div class="bg-white rounded-xl p-6 shadow-sm">
          <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center mb-4">
            <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-gray-900 mb-2">Compra en Fideicomiso</h3>
          <p class="text-gray-600 text-sm mb-4">
            La forma más segura de comprar en proyectos en construcción. Tu inversión protegida.
          </p>
          <a href="/guias/fideicomiso-inmobiliario" class="text-primary-600 font-medium text-sm hover:underline">
            Aprende cómo funciona →
          </a>
        </div>

        <!-- Para compradores USA -->
        <div class="bg-white rounded-xl p-6 shadow-sm">
          <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mb-4">
            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-gray-900 mb-2">Compradores desde USA</h3>
          <p class="text-gray-600 text-sm mb-4">
            Guía completa para estadounidenses: impuestos, financiamiento y proceso de compra.
          </p>
          <a href="/guias/comprar-desde-usa" class="text-primary-600 font-medium text-sm hover:underline">
            Ver guía completa →
          </a>
        </div>
      </div>

      <!-- Internal Links - Ubicaciones Populares -->
      <div class="mt-12">
        <h3 class="text-xl font-semibold text-gray-900 mb-6 text-center">Explora por Ubicación</h3>
        <div class="flex flex-wrap justify-center gap-3">
          <a href="/propiedades/santo-domingo" class="px-4 py-2 bg-white rounded-full text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-600 transition-colors shadow-sm">
            Santo Domingo
          </a>
          <a href="/propiedades/punta-cana" class="px-4 py-2 bg-white rounded-full text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-600 transition-colors shadow-sm">
            Punta Cana
          </a>
          <a href="/propiedades/santiago" class="px-4 py-2 bg-white rounded-full text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-600 transition-colors shadow-sm">
            Santiago
          </a>
          <a href="/propiedades/la-romana" class="px-4 py-2 bg-white rounded-full text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-600 transition-colors shadow-sm">
            La Romana
          </a>
          <a href="/propiedades/puerto-plata" class="px-4 py-2 bg-white rounded-full text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-600 transition-colors shadow-sm">
            Puerto Plata
          </a>
          <a href="/propiedades/samana" class="px-4 py-2 bg-white rounded-full text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-600 transition-colors shadow-sm">
            Samaná
          </a>
          <a href="/propiedades/santo-domingo-este" class="px-4 py-2 bg-white rounded-full text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-600 transition-colors shadow-sm">
            Santo Domingo Este
          </a>
          <a href="/propiedades/santo-domingo-norte" class="px-4 py-2 bg-white rounded-full text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-600 transition-colors shadow-sm">
            Santo Domingo Norte
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- FAQ Section - Visible -->
  <section class="py-12 bg-white">
    <div class="container-custom">
      <h2 class="text-2xl font-bold text-gray-900 mb-8 text-center">Preguntas Frecuentes</h2>
      <div class="max-w-3xl mx-auto space-y-4">
        {[...firstTimeBuyerFAQs.slice(0, 2), ...financingFAQs.slice(0, 2), ...usBuyerFAQs.slice(0, 2)].map((faq) => (
          <details class="group bg-gray-50 rounded-lg">
            <summary class="flex items-center justify-between p-4 cursor-pointer list-none">
              <span class="font-medium text-gray-900">{faq.question}</span>
              <svg class="w-5 h-5 text-gray-500 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </summary>
            <div class="px-4 pb-4 text-gray-600">
              {faq.answer}
            </div>
          </details>
        ))}
      </div>
    </div>
  </section>

  <!-- Schema.org ItemList for SEO -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "ItemList",
    "name": pageTitle,
    "description": description,
    "numberOfItems": totalCount,
    "itemListElement": results.slice(0, 10).map((property, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "item": {
        "@type": "RealEstateListing",
        "name": property.title,
        "url": `https://propiedadenrd.com/propiedad/${property.slug}`,
        "description": property.description?.substring(0, 200),
        "image": property.images[0]?.url,
        "offers": {
          "@type": "Offer",
          "price": property.price,
          "priceCurrency": property.currency,
          "availability": "https://schema.org/InStock"
        },
        "address": {
          "@type": "PostalAddress",
          "addressLocality": property.location.city,
          "addressRegion": property.location.sector,
          "addressCountry": "DO"
        }
      }
    }))
  })} />

  <!-- BreadcrumbList Schema -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Inicio",
        "item": "https://propiedadenrd.com"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": pageTitle,
        "item": `https://propiedadenrd.com/buscar${Object.keys(preserveParams).length > 0 ? '?' + new URLSearchParams(preserveParams).toString() : ''}`
      }
    ]
  })} />

  <!-- FAQ Schema for common questions -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
      ...firstTimeBuyerFAQs.slice(0, 2),
      ...financingFAQs.slice(0, 2),
      ...usBuyerFAQs.slice(0, 2)
    ].map(faq => ({
      "@type": "Question",
      "name": faq.question,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": faq.answer
      }
    }))
  })} />
</Layout>
