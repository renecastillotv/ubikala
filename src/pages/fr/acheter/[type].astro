---
import Layout from '../../../layouts/Layout.astro';
import PropertyCard from '../../../components/PropertyCard.astro';
import SearchBox from '../../../components/SearchBox.astro';
import Breadcrumb from '../../../components/Breadcrumb.astro';
import { useTranslations, getAlternateUrls } from '../../../i18n';
import { searchProperties } from '../../../lib/meilisearch';
import type { Property } from '../../../data/types';

// SSR pour les pages de type dynamiques
export const prerender = false;

// Correspondance des slugs URL français vers les types en base de données
const slugToDbType: Record<string, string> = {
  'maisons': 'casa',
  'appartements': 'apartamento',
  'villas': 'villa',
  'penthouses': 'penthouse',
  'terrains': 'terreno',
  'commerces': 'local comercial',
  'bureaux': 'oficina',
  'entrepots': 'nave',
  'immeubles': 'edificio',
};

const typeNames: Record<string, string> = {
  'maisons': 'Maisons',
  'appartements': 'Appartements',
  'villas': 'Villas',
  'penthouses': 'Penthouses',
  'terrains': 'Terrains',
  'commerces': 'Commerces',
  'bureaux': 'Bureaux',
  'entrepots': 'Entrepôts',
  'immeubles': 'Immeubles',
};

// Correspondance des slugs français vers les slugs espagnols pour les URL alternatives
const frenchToSpanishSlug: Record<string, string> = {
  'maisons': 'casas',
  'appartements': 'apartamentos',
  'villas': 'villas',
  'penthouses': 'penthouses',
  'terrains': 'terrenos',
  'commerces': 'locales-comerciales',
  'bureaux': 'oficinas',
  'entrepots': 'almacenes',
  'immeubles': 'edificios',
};

const { type: typeSlug } = Astro.params;
const t = useTranslations('fr');
const pais = Astro.locals.country.name;

const typeDescriptions: Record<string, string> = {
  'maisons': `Parcourez les maisons à vendre dans tout ${pais}. Des résidences familiales aux maisons de luxe dans les quartiers les plus recherchés.`,
  'appartements': `Explorez les appartements à vendre dans tout ${pais}. Des logements modernes avec les meilleurs équipements dans des emplacements privilégiés.`,
  'villas': `Découvrez des villas exclusives en bord de mer, des domaines sur parcours de golf et des retraites dans des communautés fermées. Le luxe caribéen haut de gamme.`,
  'penthouses': `Les penthouses les plus spectaculaires de ${pais}. Vues panoramiques, terrasses privées et finitions de première classe.`,
  'terrains': `Terrains et lots à vendre pour construire votre prochain projet. Parcelles résidentielles, commerciales et industrielles dans des emplacements stratégiques.`,
  'commerces': `Locaux commerciaux dans des zones à fort trafic. Idéal pour restaurants, boutiques, bureaux et plus encore.`,
  'bureaux': `Espaces de bureaux dans des tours d\u2019affaires et des bâtiments commerciaux. Prêts à l\u2019emploi pour votre entreprise.`,
  'entrepots': `Entrepôts industriels et installations de stockage dans les zones franches et les parcs industriels.`,
  'immeubles': `Immeubles complets à vendre comme opportunités d\u2019investissement ou de développement.`,
};

const dbType = slugToDbType[typeSlug || ''];
const typeName = typeNames[typeSlug || ''] || typeSlug?.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) || 'Propriétés';
const typeDescription = typeDescriptions[typeSlug || ''] || `Trouvez des ${typeName.toLowerCase()} à vendre en ${pais}.`;

// Rediriger vers /fr/acheter si le slug de type n'est pas reconnu
if (!dbType) {
  return Astro.redirect('/fr/acheter');
}

const spanishSlug = frenchToSpanishSlug[typeSlug || ''] || typeSlug;
const alternateUrls = getAlternateUrls(`/fr/acheter/${typeSlug}`);

// Récupérer les propriétés depuis MeiliSearch
let typeProperties: Property[] = [];
let totalCount = 0;
try {
  const result = await searchProperties({ tipo: dbType, operacion: 'venta', limit: 24, pais });
  typeProperties = result.properties;
  totalCount = result.total;
} catch (error) {
  console.error('Error fetching properties by type:', error);
}

const pageTitle = `${typeName} à Vendre en ${pais} | Ubíkala`;
---

<Layout
  title={pageTitle}
  description={typeDescription}
  keywords={`${typeName.toLowerCase()} à vendre ${pais}, acheter ${typeName.toLowerCase()}, ubikala`}
  alternateLanguages={alternateUrls}
>
  <Breadcrumb items={[
    { label: t.nav.home, href: '/fr' },
    { label: t.nav.buy, href: '/fr/acheter' },
    { label: typeName }
  ]} />

  <!-- Hero -->
  <section class="bg-gradient-to-r from-primary-600 to-primary-700 py-12">
    <div class="container-custom">
      <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">
        {typeName} à Vendre en {pais}
      </h1>
      <p class="text-primary-100 text-lg max-w-3xl">
        {typeDescription}
      </p>
    </div>
  </section>

  <!-- Recherche -->
  <section class="py-8 bg-white shadow-sm">
    <div class="container-custom">
      <SearchBox variant="inline" />
    </div>
  </section>

  <!-- Résultats -->
  <section class="section">
    <div class="container-custom">
      <div class="flex items-center justify-between mb-8">
        <p class="text-gray-600">
          <span class="font-semibold text-gray-900">{totalCount}</span> {typeName.toLowerCase()} trouvé(e)s
        </p>
        <select class="select py-2 text-sm w-auto">
          <option value="recent">Plus Récents</option>
          <option value="price-asc">Prix: Croissant</option>
          <option value="price-desc">Prix: Décroissant</option>
        </select>
      </div>

      {typeProperties.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {typeProperties.map((property) => (
            <PropertyCard property={property} />
          ))}
        </div>
      ) : (
        <div class="card p-12 text-center">
          <p class="text-gray-600 mb-4">Aucun(e) {typeName.toLowerCase()} disponible pour le moment.</p>
          <a href="/fr/acheter" class="btn-primary">Voir toutes les propriétés</a>
        </div>
      )}
    </div>
  </section>

  <!-- Contenu SEO -->
  <section class="py-12 bg-gray-50">
    <div class="container-custom">
      <div class="prose prose-lg max-w-4xl mx-auto">
        <h2>Acheter {typeName} en {pais}</h2>
        <p>
          {typeDescription} Sur Ubikala.com, les agents immobiliers et propriétaires publient
          des {typeName.toLowerCase()} dans tout le pays. Contactez directement l'agent responsable
          pour obtenir plus de détails et planifier des visites.
        </p>

        <h3>Processus d'Achat pour les Étrangers</h3>
        <p>
          Les étrangers peuvent acheter des propriétés en {pais} avec les mêmes droits que les locaux.
          Le processus est simple : trouvez une propriété, engagez un avocat local pour vérifier le titre,
          signez le contrat de vente et enregistrez le transfert. Nos agents vérifiés peuvent vous guider
          à chaque étape.
        </p>
      </div>
    </div>
  </section>
</Layout>
