---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getAllCountries, getAllSeoContentForCountry } from '../../../lib/ubikala-db';

const user = Astro.locals.user;
if (!user || user.role !== 'admin') {
  return Astro.redirect('/admin/dashboard');
}

const countries = await getAllCountries();
const selectedCountry = Astro.url.searchParams.get('country') || (countries[0]?.code || 'DO');
const selectedLang = Astro.url.searchParams.get('lang') || 'es';

let sections: any[] = [];
try {
  sections = await getAllSeoContentForCountry(selectedCountry, selectedLang);
} catch (error) {
  console.error('Error loading SEO content:', error);
}

const langs = [
  { code: 'es', label: 'Español' },
  { code: 'en', label: 'English' },
  { code: 'fr', label: 'Français' },
];
---

<AdminLayout title="Contenido SEO">
  <div class="admin-page-header">
    <div>
      <h1 class="admin-page-title">Contenido SEO</h1>
      <p class="admin-page-subtitle">Gestiona el contenido SEO por país e idioma</p>
    </div>
    <button id="add-section-btn" class="btn-primary">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;">
        <line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" />
      </svg>
      Nueva Sección
    </button>
  </div>

  <!-- Country Tabs -->
  <div class="tabs-row">
    <div class="country-tabs">
      {countries.map((c: any) => (
        <a
          href={`/admin/seo-content?country=${c.code}&lang=${selectedLang}`}
          class:list={['tab', { active: c.code === selectedCountry }]}
        >
          {c.flag} {c.code}
        </a>
      ))}
    </div>
    <div class="lang-tabs">
      {langs.map(l => (
        <a
          href={`/admin/seo-content?country=${selectedCountry}&lang=${l.code}`}
          class:list={['tab tab-lang', { active: l.code === selectedLang }]}
        >
          {l.label}
        </a>
      ))}
    </div>
  </div>

  <!-- Sections Table -->
  <div class="table-container">
    {sections.length === 0 ? (
      <div class="empty-state">
        <p>No hay contenido SEO para <strong>{selectedCountry}</strong> en <strong>{selectedLang}</strong>.</p>
        <p class="text-muted">Haz clic en "Nueva Sección" para agregar contenido, o usa el seed automático desde Configuración.</p>
      </div>
    ) : (
      <table class="data-table">
        <thead>
          <tr>
            <th>Sección</th>
            <th>Página</th>
            <th>Contenido</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {sections.map((s: any) => (
            <tr data-id={s.id}>
              <td><code class="section-code">{s.section}</code></td>
              <td>{s.page || '—'}</td>
              <td class="content-cell">
                <span class="content-preview">
                  {typeof s.content === 'string'
                    ? s.content.substring(0, 80)
                    : JSON.stringify(s.content).substring(0, 80)}...
                </span>
              </td>
              <td>
                <div class="actions">
                  <button class="btn-icon edit-btn" data-record={JSON.stringify(s)} title="Editar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                    </svg>
                  </button>
                  <button class="btn-icon delete-btn" data-id={s.id} data-section={s.section} title="Eliminar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                      <polyline points="3 6 5 6 21 6" />
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    )}
  </div>

  <!-- Modal -->
  <div id="seo-modal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content modal-wide">
      <div class="modal-header">
        <h4 id="modal-title">Nueva Sección SEO</h4>
        <button class="close-modal">&times;</button>
      </div>
      <form id="seo-form">
        <input type="hidden" id="record-id" />
        <div class="form-row">
          <div class="form-group">
            <label for="seo-section">Sección</label>
            <select id="seo-section">
              <option value="hero">hero</option>
              <option value="guide_header">guide_header</option>
              <option value="popular_zones">popular_zones</option>
              <option value="property_types">property_types</option>
              <option value="info_box">info_box</option>
              <option value="faqs">faqs</option>
              <option value="educational_cards">educational_cards</option>
              <option value="cta">cta</option>
              <option value="rental_requirements">rental_requirements</option>
              <option value="benefits">benefits</option>
              <option value="destinations_header">destinations_header</option>
              <option value="destinations">destinations</option>
              <option value="custom">— Personalizada —</option>
            </select>
          </div>
          <div class="form-group" id="custom-section-group" style="display:none;">
            <label for="seo-section-custom">Nombre personalizado</label>
            <input type="text" id="seo-section-custom" placeholder="mi_seccion" />
          </div>
          <div class="form-group">
            <label for="seo-page">Página</label>
            <select id="seo-page">
              <option value="">— Global (sin página) —</option>
              <option value="home">home</option>
              <option value="buy">buy</option>
              <option value="rent">rent</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="seo-content">Contenido (JSON)</label>
          <textarea id="seo-content" rows="16" placeholder='{"title": "...", "description": "..."}'></textarea>
        </div>
        <div id="form-error" class="form-error hidden"></div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary close-modal">Cancelar</button>
          <button type="submit" class="btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    .admin-page-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;
    }
    .admin-page-title { font-size: 1.5rem; font-weight: 700; color: #111827; }
    .admin-page-subtitle { color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem; }
    .btn-primary {
      display: inline-flex; align-items: center; gap: 0.5rem;
      padding: 0.625rem 1rem; background: var(--ubikala-olive, #5C6B3C); color: white;
      border: none; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; cursor: pointer;
    }
    .btn-primary:hover { background: var(--ubikala-olive-dark, #4A5730); }
    .tabs-row {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 1.5rem; flex-wrap: wrap; gap: 0.75rem;
    }
    .country-tabs, .lang-tabs { display: flex; gap: 0.25rem; flex-wrap: wrap; }
    .tab {
      padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.8rem; font-weight: 500;
      text-decoration: none; color: #6b7280; background: #f3f4f6; transition: all 0.15s;
    }
    .tab:hover { background: #e5e7eb; color: #374151; }
    .tab.active { background: var(--ubikala-olive, #5C6B3C); color: white; }
    .tab-lang { font-size: 0.75rem; padding: 0.375rem 0.625rem; }
    .table-container {
      background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;
    }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th, .data-table td {
      padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem;
    }
    .data-table th {
      background: #f9fafb; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: #6b7280;
    }
    .section-code {
      background: #f3f4f6; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; color: #374151;
    }
    .content-cell { max-width: 300px; }
    .content-preview { color: #6b7280; font-size: 0.8rem; word-break: break-all; }
    .actions { display: flex; gap: 0.5rem; }
    .btn-icon {
      width: 32px; height: 32px; border: none; border-radius: 0.375rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .edit-btn { background: #f3f4f6; color: #374151; }
    .edit-btn:hover { background: #e5e7eb; }
    .delete-btn { background: #fee2e2; color: #dc2626; }
    .delete-btn:hover { background: #fecaca; }
    .empty-state {
      padding: 3rem 1.5rem; text-align: center; color: #6b7280;
    }
    .text-muted { font-size: 0.8rem; color: #9ca3af; margin-top: 0.5rem; }
    /* Modal */
    .modal { position: fixed; inset: 0; z-index: 50; display: flex; align-items: center; justify-content: center; }
    .modal.hidden { display: none; }
    .modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.5); }
    .modal-content {
      position: relative; background: white; border-radius: 0.75rem;
      width: 100%; max-width: 480px; margin: 1rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }
    .modal-wide { max-width: 640px; }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1.25rem 1.5rem; border-bottom: 1px solid #e5e7eb;
    }
    .modal-header h4 { font-size: 1.125rem; font-weight: 600; color: #111827; }
    .close-modal {
      width: 32px; height: 32px; border: none; background: #f3f4f6;
      border-radius: 0.375rem; cursor: pointer; font-size: 1.25rem; color: #6b7280;
    }
    form { padding: 1.5rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-group { margin-bottom: 1rem; }
    .form-group label {
      display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 0.625rem 0.75rem; border: 1px solid #d1d5db;
      border-radius: 0.375rem; font-size: 0.875rem; font-family: inherit;
    }
    .form-group textarea { font-family: 'Courier New', monospace; font-size: 0.8rem; resize: vertical; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none; border-color: var(--ubikala-olive, #5C6B3C); box-shadow: 0 0 0 3px rgba(92,107,60,0.1);
    }
    .form-error {
      background: #fef2f2; border: 1px solid #fecaca; color: #dc2626;
      padding: 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; margin-bottom: 1rem;
    }
    .form-error.hidden { display: none; }
    .modal-footer {
      display: flex; justify-content: flex-end; gap: 0.75rem;
      padding-top: 1.5rem; border-top: 1px solid #e5e7eb; margin-top: 1rem;
    }
    .btn-secondary {
      padding: 0.625rem 1.25rem; background: #f3f4f6; color: #374151;
      border: none; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; cursor: pointer;
    }
    .btn-secondary:hover { background: #e5e7eb; }
  </style>

  <script define:vars={{ selectedCountry, selectedLang }}>
    const modal = document.getElementById('seo-modal');
    const modalTitle = document.getElementById('modal-title');
    const form = document.getElementById('seo-form');
    const formError = document.getElementById('form-error');
    const recordIdInput = document.getElementById('record-id');
    const sectionSelect = document.getElementById('seo-section');
    const customSectionGroup = document.getElementById('custom-section-group');
    const customSectionInput = document.getElementById('seo-section-custom');
    const pageSelect = document.getElementById('seo-page');
    const contentTextarea = document.getElementById('seo-content');

    // Toggle custom section input
    sectionSelect.addEventListener('change', () => {
      customSectionGroup.style.display = sectionSelect.value === 'custom' ? 'block' : 'none';
    });

    // Open modal for new section
    document.getElementById('add-section-btn')?.addEventListener('click', () => {
      modalTitle.textContent = 'Nueva Sección SEO';
      form.reset();
      recordIdInput.value = '';
      sectionSelect.disabled = false;
      pageSelect.disabled = false;
      customSectionGroup.style.display = 'none';
      formError.classList.add('hidden');
      modal.classList.remove('hidden');
    });

    // Open modal for edit
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const record = JSON.parse(btn.dataset.record || '{}');
        modalTitle.textContent = 'Editar Sección SEO';
        recordIdInput.value = record.id;

        // Set section — if not in the dropdown options, use "custom"
        const option = sectionSelect.querySelector(`option[value="${record.section}"]`);
        if (option) {
          sectionSelect.value = record.section;
          customSectionGroup.style.display = 'none';
        } else {
          sectionSelect.value = 'custom';
          customSectionInput.value = record.section;
          customSectionGroup.style.display = 'block';
        }
        sectionSelect.disabled = true;

        pageSelect.value = record.page || '';
        pageSelect.disabled = true;

        contentTextarea.value = typeof record.content === 'string'
          ? record.content
          : JSON.stringify(record.content, null, 2);

        formError.classList.add('hidden');
        modal.classList.remove('hidden');
      });
    });

    // Close modal
    document.querySelectorAll('.close-modal, .modal-backdrop').forEach(el => {
      el.addEventListener('click', () => modal.classList.add('hidden'));
    });

    // Handle form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      formError.classList.add('hidden');

      const isEdit = !!recordIdInput.value;
      const section = sectionSelect.value === 'custom' ? customSectionInput.value.trim() : sectionSelect.value;
      const page = pageSelect.value || null;

      // Parse content JSON
      let content;
      try {
        content = JSON.parse(contentTextarea.value);
      } catch {
        formError.textContent = 'El contenido debe ser JSON válido';
        formError.classList.remove('hidden');
        return;
      }

      try {
        if (isEdit) {
          const res = await fetch(`/api/admin/seo-content/${recordIdInput.value}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content }),
          });
          if (!res.ok) throw new Error((await res.json()).error || 'Error al actualizar');
        } else {
          if (!section) {
            formError.textContent = 'Selecciona una sección';
            formError.classList.remove('hidden');
            return;
          }
          const res = await fetch('/api/admin/seo-content', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ country_code: selectedCountry, lang: selectedLang, section, page, content }),
          });
          if (!res.ok) throw new Error((await res.json()).error || 'Error al crear');
        }
        window.location.reload();
      } catch (err) {
        formError.textContent = err.message;
        formError.classList.remove('hidden');
      }
    });

    // Handle delete
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const section = btn.dataset.section;
        if (!confirm(`¿Eliminar sección "${section}"?`)) return;

        try {
          const res = await fetch(`/api/admin/seo-content/${id}`, { method: 'DELETE' });
          if (!res.ok) throw new Error('Error al eliminar');
          window.location.reload();
        } catch (err) {
          alert(err.message);
        }
      });
    });
  </script>
</AdminLayout>
