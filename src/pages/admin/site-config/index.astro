---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getAllCountries, getAllSiteConfigs } from '../../../lib/ubikala-db';

const user = Astro.locals.user;
if (!user || user.role !== 'admin') {
  return Astro.redirect('/admin/dashboard');
}

let countries: any[] = [];
let existingConfigs: Record<string, any> = {};
try {
  const [dbCountries, configs] = await Promise.all([
    getAllCountries(),
    getAllSiteConfigs()
  ]);
  countries = dbCountries;
  configs.forEach(c => { existingConfigs[c.country_code] = c; });
} catch (error) {
  console.error('Error loading site config data:', error);
}

const selectedCountry = Astro.url.searchParams.get('country') || (countries[0]?.code || 'DO');
---

<AdminLayout title="Ubikala.com - Configuraci√≥n">
  <div class="admin-page-header">
    <div>
      <h1 class="admin-page-title">Ubikala.com</h1>
      <p class="admin-page-subtitle">Configuraci√≥n de la plataforma por pa√≠s</p>
    </div>
  </div>

  <!-- Country Tabs -->
  <div class="country-tabs-container">
    <div class="country-tabs" id="country-tabs">
      {countries.map(c => (
        <button
          class={`country-tab ${c.code === selectedCountry ? 'active' : ''}`}
          data-country={c.code}
        >
          <span class="country-tab-flag">{c.flag}</span>
          <span class="country-tab-name">{c.name}</span>
          {existingConfigs[c.code] && <span class="country-tab-dot"></span>}
        </button>
      ))}
    </div>
    <button class="add-country-btn" id="add-country-btn" title="Crear otro pa√≠s">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      <span>Crear Pa√≠s</span>
    </button>
  </div>

  <!-- Create Country Modal -->
  <div class="modal-overlay" id="country-modal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Crear Nuevo Pa√≠s</h2>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <form id="country-form" class="modal-body">
        <div class="config-grid">
          <div class="config-field">
            <label for="c_code">C√≥digo ISO (2 letras)</label>
            <input type="text" id="c_code" name="code" maxlength="2" placeholder="PA" required style="text-transform: uppercase;" />
          </div>
          <div class="config-field">
            <label for="c_name">Nombre del pa√≠s</label>
            <input type="text" id="c_name" name="name" placeholder="Panam√°" required />
          </div>
          <div class="config-field">
            <label for="c_flag">Bandera (emoji)</label>
            <input type="text" id="c_flag" name="flag" placeholder="üáµüá¶" />
          </div>
          <div class="config-field">
            <label for="c_subdomain">Subdominio</label>
            <input type="text" id="c_subdomain" name="subdomain" placeholder="pa" />
            <small class="field-hint">ej: pa ‚Üí pa.ubikala.com (vac√≠o = dominio principal)</small>
          </div>
          <div class="config-field">
            <label for="c_domain">Dominio</label>
            <input type="text" id="c_domain" name="domain" placeholder="ubikala.com" />
          </div>
          <div class="config-field">
            <label for="c_currency">Moneda (c√≥digo)</label>
            <input type="text" id="c_currency" name="currency" maxlength="3" placeholder="USD" />
          </div>
          <div class="config-field">
            <label for="c_currency_symbol">S√≠mbolo moneda</label>
            <input type="text" id="c_currency_symbol" name="currency_symbol" placeholder="$" />
          </div>
          <div class="config-field">
            <label for="c_phone_prefix">Prefijo telef√≥nico</label>
            <input type="text" id="c_phone_prefix" name="phone_prefix" placeholder="+507" />
          </div>
          <div class="config-field">
            <label for="c_timezone">Zona horaria</label>
            <input type="text" id="c_timezone" name="timezone" placeholder="America/Panama" />
          </div>
          <div class="config-field">
            <label for="c_phone_placeholder">Placeholder tel√©fono</label>
            <input type="text" id="c_phone_placeholder" name="phone_placeholder" placeholder="6000-0000" />
          </div>
          <div class="config-field">
            <label for="c_lat">Latitud</label>
            <input type="text" id="c_lat" name="lat" placeholder="8.9824" />
          </div>
          <div class="config-field">
            <label for="c_lng">Longitud</label>
            <input type="text" id="c_lng" name="lng" placeholder="-79.5199" />
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="cancel-btn" id="modal-cancel">Cancelar</button>
          <button type="submit" class="save-btn" id="country-save-btn">Crear Pa√≠s</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Config Form -->
  <form id="site-config-form" class="config-form">
    <input type="hidden" name="country_code" id="country-code" value={selectedCountry} />

    <!-- Section: Identity -->
    <div class="config-section">
      <h2 class="config-section-title">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
        </svg>
        Identidad
      </h2>
      <div class="config-grid">
        <div class="config-field">
          <label for="domain">Dominio</label>
          <input type="text" id="domain" name="domain" placeholder="ubikala.com" />
        </div>
        <div class="config-field">
          <label for="company_name">Nombre de la empresa</label>
          <input type="text" id="company_name" name="company_name" placeholder="Ubikala" />
        </div>
        <div class="config-field full-width">
          <label for="company_slogan">Eslogan</label>
          <input type="text" id="company_slogan" name="company_slogan" placeholder="Esa propiedad que buscas, ub√≠kala aqu√≠" />
        </div>
        <div class="config-field">
          <label for="logo_url">URL del Logo</label>
          <input type="text" id="logo_url" name="logo_url" placeholder="/logo.png" />
        </div>
        <div class="config-field">
          <label for="favicon_url">URL del Favicon</label>
          <input type="text" id="favicon_url" name="favicon_url" placeholder="/favicon.ico" />
        </div>
      </div>
    </div>

    <!-- Section: Contact -->
    <div class="config-section">
      <h2 class="config-section-title">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
        </svg>
        Contacto
      </h2>
      <div class="config-grid">
        <div class="config-field">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" placeholder="info@ubikala.com" />
        </div>
        <div class="config-field">
          <label for="phone">Tel√©fono</label>
          <input type="text" id="phone" name="phone" placeholder="+18095550000" />
        </div>
        <div class="config-field">
          <label for="phone_display">Tel√©fono (formato display)</label>
          <input type="text" id="phone_display" name="phone_display" placeholder="+1 809-555-0000" />
        </div>
        <div class="config-field">
          <label for="whatsapp">WhatsApp (solo n√∫meros)</label>
          <input type="text" id="whatsapp" name="whatsapp" placeholder="18095550000" />
        </div>
        <div class="config-field">
          <label for="business_hours">Horario de atenci√≥n</label>
          <input type="text" id="business_hours" name="business_hours" placeholder="Lun-Vie 9am-6pm" />
        </div>
      </div>
    </div>

    <!-- Section: Location -->
    <div class="config-section">
      <h2 class="config-section-title">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        Ubicaci√≥n
      </h2>
      <div class="config-grid">
        <div class="config-field full-width">
          <label for="address_street">Direcci√≥n</label>
          <input type="text" id="address_street" name="address_street" placeholder="Calle principal #123" />
        </div>
        <div class="config-field">
          <label for="address_city">Ciudad</label>
          <input type="text" id="address_city" name="address_city" placeholder="Santo Domingo" />
        </div>
        <div class="config-field">
          <label for="address_country">Pa√≠s</label>
          <input type="text" id="address_country" name="address_country" placeholder="Rep√∫blica Dominicana" />
        </div>
        <div class="config-field">
          <label for="geo_latitude">Latitud</label>
          <input type="text" id="geo_latitude" name="geo_latitude" placeholder="18.7357" />
        </div>
        <div class="config-field">
          <label for="geo_longitude">Longitud</label>
          <input type="text" id="geo_longitude" name="geo_longitude" placeholder="-70.1627" />
        </div>
      </div>
    </div>

    <!-- Section: Social Media -->
    <div class="config-section">
      <h2 class="config-section-title">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
        </svg>
        Redes Sociales
      </h2>
      <div class="config-grid">
        <div class="config-field">
          <label for="social_facebook">Facebook</label>
          <input type="url" id="social_facebook" name="social_facebook" placeholder="https://facebook.com/ubikala" />
        </div>
        <div class="config-field">
          <label for="social_instagram">Instagram</label>
          <input type="url" id="social_instagram" name="social_instagram" placeholder="https://instagram.com/ubikala" />
        </div>
        <div class="config-field">
          <label for="social_linkedin">LinkedIn</label>
          <input type="url" id="social_linkedin" name="social_linkedin" placeholder="https://linkedin.com/company/ubikala" />
        </div>
        <div class="config-field">
          <label for="social_youtube">YouTube</label>
          <input type="url" id="social_youtube" name="social_youtube" placeholder="https://youtube.com/@ubikala" />
        </div>
        <div class="config-field">
          <label for="social_twitter">Twitter / X</label>
          <input type="url" id="social_twitter" name="social_twitter" placeholder="https://x.com/ubikala" />
        </div>
        <div class="config-field">
          <label for="social_tiktok">TikTok</label>
          <input type="url" id="social_tiktok" name="social_tiktok" placeholder="https://tiktok.com/@ubikala" />
        </div>
      </div>
    </div>

    <!-- Section: SEO -->
    <div class="config-section">
      <h2 class="config-section-title">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        SEO
      </h2>
      <div class="config-grid">
        <div class="config-field full-width">
          <label for="meta_title">Meta Title</label>
          <input type="text" id="meta_title" name="meta_title" placeholder="Ubikala - Esa propiedad que buscas, ub√≠kala aqu√≠" />
        </div>
        <div class="config-field full-width">
          <label for="meta_description">Meta Description</label>
          <textarea id="meta_description" name="meta_description" rows="2" placeholder="Encuentra casas, apartamentos y terrenos en venta y alquiler."></textarea>
        </div>
        <div class="config-field full-width">
          <label for="og_image">OG Image URL</label>
          <input type="text" id="og_image" name="og_image" placeholder="https://ubikala.com/og-image.jpg" />
        </div>
      </div>
    </div>

    <!-- Section: SMTP (MXRoute) -->
    <div class="config-section">
      <h2 class="config-section-title">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
        Email SMTP (MXRoute)
      </h2>
      <div class="config-grid">
        <div class="config-field">
          <label for="smtp_host">Host SMTP</label>
          <input type="text" id="smtp_host" name="smtp_host" placeholder="mail.example.com" />
        </div>
        <div class="config-field">
          <label for="smtp_port">Puerto</label>
          <input type="number" id="smtp_port" name="smtp_port" placeholder="587" />
        </div>
        <div class="config-field">
          <label for="smtp_user">Usuario</label>
          <input type="text" id="smtp_user" name="smtp_user" placeholder="noreply@ubikala.com" />
        </div>
        <div class="config-field">
          <label for="smtp_password">Contrase√±a</label>
          <input type="password" id="smtp_password" name="smtp_password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <div class="config-field">
          <label for="smtp_from_email">From Email</label>
          <input type="email" id="smtp_from_email" name="smtp_from_email" placeholder="noreply@ubikala.com" />
        </div>
        <div class="config-field">
          <label for="smtp_from_name">From Name</label>
          <input type="text" id="smtp_from_name" name="smtp_from_name" placeholder="Ubikala" />
        </div>
        <div class="config-field">
          <label for="smtp_encryption">Encriptaci√≥n</label>
          <select id="smtp_encryption" name="smtp_encryption">
            <option value="tls">TLS</option>
            <option value="ssl">SSL</option>
            <option value="none">Ninguna</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="config-actions">
      <div id="save-status" class="save-status"></div>
      <button type="submit" class="save-btn" id="save-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        Guardar Configuraci√≥n
      </button>
    </div>
  </form>

  <!-- SEO Content Status -->
  <div class="config-section" style="margin-top: 2rem;">
    <h2 class="config-section-title">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h10" />
      </svg>
      Contenido SEO
    </h2>
    <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
      <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.75rem;">
        Gestiona el contenido SEO (textos, FAQs, secciones) para este pa√≠s en cada idioma.
      </p>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <a href={`/admin/seo-content?country=${selectedCountry}&lang=es`}
           style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.5rem 1rem; background: white; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.8rem; color: #374151; text-decoration: none;">
          Espa√±ol
        </a>
        <a href={`/admin/seo-content?country=${selectedCountry}&lang=en`}
           style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.5rem 1rem; background: white; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.8rem; color: #374151; text-decoration: none;">
          English
        </a>
        <a href={`/admin/seo-content?country=${selectedCountry}&lang=fr`}
           style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.5rem 1rem; background: white; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.8rem; color: #374151; text-decoration: none;">
          Fran√ßais
        </a>
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  .country-tabs-container {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0 1.5rem;
    margin-bottom: 1.5rem;
  }

  .country-tabs {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    flex: 1;
  }

  .country-tab {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    border: 2px solid var(--ubikala-sand);
    border-radius: 0.5rem;
    background: white;
    cursor: pointer;
    white-space: nowrap;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--ubikala-warm-gray);
    transition: all 0.2s;
    position: relative;
  }

  .country-tab:hover {
    border-color: var(--ubikala-olive-light);
    color: var(--ubikala-olive);
  }

  .country-tab.active {
    border-color: var(--ubikala-olive);
    background: var(--ubikala-olive);
    color: white;
  }

  .country-tab-flag {
    font-size: 1.25rem;
  }

  .country-tab-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--ubikala-terracotta);
    position: absolute;
    top: 4px;
    right: 4px;
  }

  .country-tab.active .country-tab-dot {
    background: white;
  }

  .add-country-btn {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.625rem 1rem;
    border: 2px dashed var(--ubikala-sand);
    border-radius: 0.5rem;
    background: transparent;
    cursor: pointer;
    white-space: nowrap;
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--ubikala-olive);
    transition: all 0.2s;
  }

  .add-country-btn:hover {
    border-color: var(--ubikala-olive);
    background: var(--ubikala-olive-light);
    background: rgba(92, 107, 60, 0.08);
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 1rem;
  }

  .modal {
    background: white;
    border-radius: 0.75rem;
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--ubikala-sand-light);
  }

  .modal-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--ubikala-olive-dark);
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--ubikala-warm-gray);
    cursor: pointer;
    padding: 0.25rem;
    line-height: 1;
  }

  .modal-close:hover {
    color: var(--ubikala-terracotta);
  }

  .modal-body {
    padding: 1.5rem;
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--ubikala-sand-light);
  }

  .cancel-btn {
    padding: 0.5rem 1.25rem;
    border: 1px solid var(--ubikala-sand);
    border-radius: 0.375rem;
    background: white;
    color: var(--ubikala-warm-gray);
    font-weight: 500;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .cancel-btn:hover {
    background: var(--ubikala-ivory);
    border-color: var(--ubikala-warm-gray);
  }

  .field-hint {
    font-size: 0.75rem;
    color: var(--ubikala-warm-gray);
    margin-top: 0.125rem;
  }

  .config-form {
    padding: 0 1.5rem 2rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .config-section {
    background: white;
    border: 1px solid var(--ubikala-sand-light);
    border-radius: 0.75rem;
    padding: 1.5rem;
  }

  .config-section-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    color: var(--ubikala-olive-dark);
    margin-bottom: 1.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--ubikala-sand-light);
  }

  .config-section-title svg {
    color: var(--ubikala-olive);
  }

  .config-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .config-field {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .config-field.full-width {
    grid-column: 1 / -1;
  }

  .config-field label {
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--ubikala-warm-gray);
  }

  .config-field input,
  .config-field select,
  .config-field textarea {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--ubikala-sand);
    border-radius: 0.375rem;
    font-size: 0.875rem;
    color: var(--ubikala-warm-gray-dark);
    background: var(--ubikala-ivory-pure);
    transition: border-color 0.2s;
  }

  .config-field input:focus,
  .config-field select:focus,
  .config-field textarea:focus {
    outline: none;
    border-color: var(--ubikala-olive);
    box-shadow: 0 0 0 2px rgba(92, 107, 60, 0.15);
  }

  .config-field textarea {
    resize: vertical;
    min-height: 60px;
  }

  .config-actions {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 1rem;
    padding: 1rem 0;
    position: sticky;
    bottom: 0;
    background: var(--ubikala-ivory);
    border-top: 1px solid var(--ubikala-sand-light);
    z-index: 10;
    margin: 0 -1.5rem;
    padding: 1rem 1.5rem;
  }

  .save-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.5rem;
    background: var(--ubikala-olive);
    color: white;
    border: none;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .save-btn:hover {
    background: var(--ubikala-olive-dark);
  }

  .save-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .save-status {
    font-size: 0.875rem;
    font-weight: 500;
  }

  .save-status.success {
    color: var(--ubikala-olive);
  }

  .save-status.error {
    color: var(--ubikala-terracotta);
  }

  @media (max-width: 768px) {
    .config-grid {
      grid-template-columns: 1fr;
    }
    .config-form {
      padding: 0 1rem 2rem;
    }
    .country-tabs-container {
      padding: 0 1rem;
      flex-direction: column;
      align-items: stretch;
    }
    .add-country-btn {
      justify-content: center;
    }
  }
</style>

<script is:inline define:vars={{ existingConfigs, selectedCountry }}>
  document.addEventListener('DOMContentLoaded', function() {
    var form = document.getElementById('site-config-form');
    var countryInput = document.getElementById('country-code');
    var saveBtn = document.getElementById('save-btn');
    var saveStatus = document.getElementById('save-status');
    var currentCountry = selectedCountry;
    var configs = existingConfigs || {};

    // Field names that the form manages
    var fields = [
      'domain', 'company_name', 'company_slogan', 'logo_url', 'favicon_url',
      'email', 'phone', 'phone_display', 'whatsapp', 'business_hours',
      'address_street', 'address_city', 'address_country', 'geo_latitude', 'geo_longitude',
      'social_facebook', 'social_instagram', 'social_linkedin', 'social_youtube', 'social_twitter', 'social_tiktok',
      'meta_title', 'meta_description', 'og_image',
      'smtp_host', 'smtp_port', 'smtp_user', 'smtp_password', 'smtp_from_email', 'smtp_from_name', 'smtp_encryption'
    ];

    function loadConfig(countryCode) {
      var config = configs[countryCode] || {};
      fields.forEach(function(field) {
        var el = document.getElementById(field);
        if (el) {
          el.value = config[field] || '';
        }
      });
      countryInput.value = countryCode;
      currentCountry = countryCode;

      // Update active tab
      document.querySelectorAll('.country-tab').forEach(function(tab) {
        tab.classList.toggle('active', tab.getAttribute('data-country') === countryCode);
      });
    }

    // Tab click handlers
    document.querySelectorAll('.country-tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        var cc = this.getAttribute('data-country');
        loadConfig(cc);
      });
    });

    // Load initial config
    loadConfig(currentCountry);

    // Form submit - save site config
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      saveBtn.disabled = true;
      saveStatus.textContent = 'Guardando...';
      saveStatus.className = 'save-status';

      var data = { country_code: currentCountry };
      fields.forEach(function(field) {
        var el = document.getElementById(field);
        if (el) {
          var val = el.value.trim();
          if (field === 'smtp_port') {
            data[field] = val ? parseInt(val) : 587;
          } else {
            data[field] = val || null;
          }
        }
      });

      try {
        var response = await fetch('/api/admin/site-config/' + currentCountry, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          var result = await response.json();
          configs[currentCountry] = result.config;
          saveStatus.textContent = 'Guardado correctamente';
          saveStatus.className = 'save-status success';

          // Update dot indicator for this tab
          var activeTab = document.querySelector('.country-tab[data-country="' + currentCountry + '"]');
          if (activeTab && !activeTab.querySelector('.country-tab-dot')) {
            var dot = document.createElement('span');
            dot.className = 'country-tab-dot';
            activeTab.appendChild(dot);
          }
        } else {
          var err = await response.json();
          throw new Error(err.error || 'Error al guardar');
        }
      } catch (error) {
        saveStatus.textContent = error.message || 'Error al guardar';
        saveStatus.className = 'save-status error';
      } finally {
        saveBtn.disabled = false;
        setTimeout(function() { saveStatus.textContent = ''; }, 4000);
      }
    });

    // --- Create Country Modal ---
    var modal = document.getElementById('country-modal');
    var addBtn = document.getElementById('add-country-btn');
    var closeBtn = document.getElementById('modal-close');
    var cancelBtn = document.getElementById('modal-cancel');
    var countryForm = document.getElementById('country-form');
    var countrySaveBtn = document.getElementById('country-save-btn');

    function openModal() {
      modal.style.display = 'flex';
      countryForm.reset();
    }

    function closeModal() {
      modal.style.display = 'none';
    }

    addBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);

    // Close on overlay click
    modal.addEventListener('click', function(e) {
      if (e.target === modal) closeModal();
    });

    // Escape key to close
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal.style.display !== 'none') closeModal();
    });

    // Submit new country
    countryForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      countrySaveBtn.disabled = true;
      countrySaveBtn.textContent = 'Guardando...';

      var countryFields = ['code', 'name', 'flag', 'subdomain', 'domain', 'currency', 'currency_symbol',
                           'phone_prefix', 'phone_placeholder', 'timezone', 'lat', 'lng'];
      var data = {};
      countryFields.forEach(function(f) {
        var el = document.getElementById('c_' + f);
        if (el) {
          var val = el.value.trim();
          if (f === 'code') val = val.toUpperCase();
          if (f === 'lat' || f === 'lng') {
            data[f] = val ? parseFloat(val) : 0;
          } else {
            data[f] = val || '';
          }
        }
      });

      if (!data.code || !data.name) {
        alert('C√≥digo y nombre son requeridos');
        countrySaveBtn.disabled = false;
        countrySaveBtn.textContent = 'Crear Pa√≠s';
        return;
      }

      try {
        var response = await fetch('/api/admin/countries', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          // Reload the page to show the new country tab
          window.location.href = '/admin/site-config?country=' + data.code;
        } else {
          var err = await response.json();
          throw new Error(err.error || 'Error al crear pa√≠s');
        }
      } catch (error) {
        alert(error.message || 'Error al crear pa√≠s');
        countrySaveBtn.disabled = false;
        countrySaveBtn.textContent = 'Crear Pa√≠s';
      }
    });
  });
</script>
