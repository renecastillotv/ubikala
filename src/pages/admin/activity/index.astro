---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getActivityLog } from '../../../lib/ubikala-db';

const user = Astro.locals.user;
const activities = await getActivityLog({ limit: 100 });

const actionLabels: Record<string, string> = {
  login_success: 'Inicio de sesión',
  login_failed: 'Intento de login fallido',
  logout: 'Cerró sesión',
  user_created: 'Usuario creado',
  user_updated: 'Usuario actualizado',
  user_deleted: 'Usuario eliminado',
  property_created: 'Propiedad creada',
  property_updated: 'Propiedad actualizada',
  property_deleted: 'Propiedad eliminada',
};

const actionIcons: Record<string, string> = {
  login_success: 'login',
  login_failed: 'alert',
  logout: 'logout',
  user_created: 'user-plus',
  user_updated: 'user-edit',
  user_deleted: 'user-minus',
  property_created: 'building-plus',
  property_updated: 'building-edit',
  property_deleted: 'building-minus',
};
---

<AdminLayout title="Actividad">
  <div class="activity-page">
    <div class="page-header">
      <h3>Registro de Actividad</h3>
    </div>

    <div class="activity-container">
      {activities.length === 0 ? (
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
          </svg>
          <h4>Sin actividad</h4>
          <p>No hay registros de actividad todavía</p>
        </div>
      ) : (
        <div class="activity-timeline">
          {activities.map(activity => (
            <div class="activity-item">
              <div class:list={['activity-icon', activity.action.includes('failed') || activity.action.includes('deleted') ? 'danger' : activity.action.includes('created') ? 'success' : 'default']}>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  {actionIcons[activity.action] === 'login' && <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4 M10 17l5-5-5-5 M15 12H3" />}
                  {actionIcons[activity.action] === 'logout' && <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9" />}
                  {actionIcons[activity.action] === 'alert' && <><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></>}
                  {actionIcons[activity.action]?.includes('user') && <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>}
                  {actionIcons[activity.action]?.includes('building') && <path d="M3 21h18 M5 21V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16" />}
                  {!actionIcons[activity.action] && <><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></>}
                </svg>
              </div>
              <div class="activity-content">
                <div class="activity-header">
                  <span class="activity-action">{actionLabels[activity.action] || activity.action}</span>
                  <span class="activity-time">{new Date(activity.created_at).toLocaleString('es-DO')}</span>
                </div>
                <div class="activity-meta">
                  <span class="activity-user">
                    {activity.user_name ? (
                      <>Por <strong>{activity.user_name}</strong> ({activity.user_email})</>
                    ) : (
                      'Sistema'
                    )}
                  </span>
                  {activity.details && Object.keys(activity.details).length > 0 && (
                    <div class="activity-details">
                      {activity.details.email && <span>Email: {activity.details.email}</span>}
                      {activity.details.titulo && <span>Propiedad: {activity.details.titulo}</span>}
                      {activity.details.slug && <span>Slug: {activity.details.slug}</span>}
                      {activity.details.role && <span>Rol: {activity.details.role}</span>}
                      {activity.details.fields && <span>Campos: {activity.details.fields.join(', ')}</span>}
                      {activity.details.reason && <span>Razón: {activity.details.reason}</span>}
                    </div>
                  )}
                </div>
                {activity.ip_address && (
                  <span class="activity-ip">IP: {activity.ip_address}</span>
                )}
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  </div>

  <style>
    .activity-page {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .page-header h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #111827;
    }
    .activity-container {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .activity-timeline {
      padding: 1rem 0;
    }
    .activity-item {
      display: flex;
      gap: 1rem;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #f3f4f6;
    }
    .activity-item:last-child {
      border-bottom: none;
    }
    .activity-item:hover {
      background: #f9fafb;
    }
    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .activity-icon svg {
      width: 20px;
      height: 20px;
    }
    .activity-icon.default {
      background: #e5e7eb;
      color: #6b7280;
    }
    .activity-icon.success {
      background: #dcfce7;
      color: #16a34a;
    }
    .activity-icon.danger {
      background: #fee2e2;
      color: #dc2626;
    }
    .activity-content {
      flex: 1;
      min-width: 0;
    }
    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.25rem;
    }
    .activity-action {
      font-weight: 600;
      color: #111827;
      font-size: 0.9375rem;
    }
    .activity-time {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .activity-meta {
      font-size: 0.8125rem;
      color: #6b7280;
    }
    .activity-user strong {
      color: #374151;
    }
    .activity-details {
      margin-top: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: #f9fafb;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .activity-ip {
      display: block;
      margin-top: 0.25rem;
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
    }
    .empty-state svg {
      width: 64px;
      height: 64px;
      color: #9ca3af;
      margin-bottom: 1rem;
    }
    .empty-state h4 {
      font-size: 1.125rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.5rem;
    }
    .empty-state p {
      color: #6b7280;
    }
  </style>
</AdminLayout>
