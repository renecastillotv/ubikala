---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getAllPromoCodes, getAllPlans } from '../../../lib/ubikala-db';

const user = Astro.locals.user;

if (!user || user.role !== 'admin') {
  return Astro.redirect('/admin/dashboard');
}

const promoCodes = await getAllPromoCodes();
const plans = await getAllPlans();
---

<AdminLayout title="Códigos Promocionales">
  <div class="promo-page">
    <div class="page-header">
      <div>
        <h2>Códigos Promocionales</h2>
        <p class="subtitle">Gestiona códigos de descuento y promociones</p>
      </div>
      <button class="btn-primary" id="new-promo-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19" />
          <line x1="5" y1="12" x2="19" y2="12" />
        </svg>
        Nuevo Código
      </button>
    </div>

    <div class="promo-list">
      {promoCodes.length === 0 ? (
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
          </svg>
          <h3>No hay códigos promocionales</h3>
          <p>Crea tu primer código promocional para ofrecer descuentos a tus usuarios.</p>
        </div>
      ) : (
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Código</th>
                <th>Tipo</th>
                <th>Valor</th>
                <th>Uso</th>
                <th>Validez</th>
                <th>Estado</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {promoCodes.map(promo => (
                <tr>
                  <td>
                    <code class="promo-code">{promo.code}</code>
                    {promo.description && <span class="promo-desc">{promo.description}</span>}
                  </td>
                  <td>
                    <span class="type-badge">
                      {promo.discount_type === 'percentage' && 'Porcentaje'}
                      {promo.discount_type === 'fixed' && 'Monto Fijo'}
                      {promo.discount_type === 'trial_days' && 'Días Gratis'}
                      {promo.discount_type === 'free_months' && 'Meses Gratis'}
                    </span>
                  </td>
                  <td class="value-cell">
                    {promo.discount_type === 'percentage' && `${promo.discount_value}%`}
                    {promo.discount_type === 'fixed' && `$${promo.discount_value}`}
                    {promo.discount_type === 'trial_days' && `${promo.discount_value} días`}
                    {promo.discount_type === 'free_months' && `${promo.discount_value} meses`}
                  </td>
                  <td>
                    <span class="usage">
                      {promo.used_count} / {promo.max_uses || '∞'}
                    </span>
                  </td>
                  <td class="validity-cell">
                    {promo.valid_until ? (
                      new Date(promo.valid_until) < new Date() ? (
                        <span class="expired">Expirado</span>
                      ) : (
                        <span class="valid">Hasta {new Date(promo.valid_until).toLocaleDateString('es-DO')}</span>
                      )
                    ) : (
                      <span class="valid">Sin expiración</span>
                    )}
                  </td>
                  <td>
                    <span class:list={['status-badge', promo.is_active ? 'active' : 'inactive']}>
                      {promo.is_active ? 'Activo' : 'Inactivo'}
                    </span>
                  </td>
                  <td>
                    <div class="actions">
                      <button class="btn-icon edit-btn" data-id={promo.id} title="Editar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                        </svg>
                      </button>
                      <button class="btn-icon delete-btn" data-id={promo.id} title="Eliminar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="3 6 5 6 21 6" />
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <div id="promo-modal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Nuevo Código Promocional</h3>
        <button class="modal-close" id="close-modal">&times;</button>
      </div>
      <form id="promo-form">
        <input type="hidden" id="promo-id" />
        <div class="form-row">
          <div class="form-group">
            <label for="promo-code-input">Código *</label>
            <input type="text" id="promo-code-input" placeholder="DESCUENTO20" required style="text-transform: uppercase;" />
            <span class="hint">El código se convertirá a mayúsculas automáticamente</span>
          </div>
          <div class="form-group">
            <label for="promo-type">Tipo de Descuento *</label>
            <select id="promo-type" required>
              <option value="percentage">Porcentaje (%)</option>
              <option value="fixed">Monto Fijo ($)</option>
              <option value="trial_days">Días de Prueba Gratis</option>
              <option value="free_months">Meses Gratis</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="promo-value">Valor *</label>
            <input type="number" id="promo-value" min="0" step="0.01" required />
            <span class="hint" id="value-hint">Ingresa el porcentaje de descuento</span>
          </div>
          <div class="form-group">
            <label for="promo-max-uses">Usos Máximos</label>
            <input type="number" id="promo-max-uses" min="0" placeholder="Sin límite" />
            <span class="hint">Dejar vacío para uso ilimitado</span>
          </div>
        </div>
        <div class="form-group">
          <label for="promo-description">Descripción</label>
          <input type="text" id="promo-description" placeholder="Ej: Descuento de lanzamiento" />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="promo-valid-from">Válido Desde</label>
            <input type="date" id="promo-valid-from" />
          </div>
          <div class="form-group">
            <label for="promo-valid-until">Válido Hasta</label>
            <input type="date" id="promo-valid-until" />
            <span class="hint">Dejar vacío para sin expiración</span>
          </div>
        </div>
        <div class="form-group">
          <label>Aplicable a Roles</label>
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" name="roles" value="inmobiliaria" /> Inmobiliaria
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="roles" value="asesor_independiente" /> Asesor Independiente
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="roles" value="propietario" /> Propietario
            </label>
          </div>
          <span class="hint">Dejar vacío para aplicar a todos los roles</span>
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="promo-active" checked /> Código activo
          </label>
        </div>
        <div id="form-message" class="form-message hidden"></div>
        <div class="modal-footer">
          <button type="button" class="btn-outline" id="cancel-btn">Cancelar</button>
          <button type="submit" class="btn-primary" id="save-btn">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    .promo-page {
      max-width: 1200px;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1.5rem;
    }
    .page-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #111827;
      margin: 0;
    }
    .subtitle {
      color: #6b7280;
      font-size: 0.875rem;
      margin: 0.25rem 0 0 0;
    }
    .promo-list {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .empty-state {
      padding: 3rem;
      text-align: center;
      color: #6b7280;
    }
    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    .empty-state h3 {
      font-size: 1.125rem;
      color: #374151;
      margin: 0 0 0.5rem 0;
    }
    .empty-state p {
      margin: 0;
      font-size: 0.875rem;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 0.875rem 1rem;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    th {
      font-size: 0.75rem;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      background: #f9fafb;
    }
    td {
      font-size: 0.875rem;
      color: #374151;
    }
    .promo-code {
      font-family: monospace;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--ubikala-olive, #5C6B3C);
      background: #f3f4f6;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
    }
    .promo-desc {
      display: block;
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
    .type-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      background: #e0e7ff;
      color: #4338ca;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .value-cell {
      font-weight: 600;
      color: var(--ubikala-olive, #5C6B3C);
    }
    .usage {
      font-size: 0.8125rem;
    }
    .validity-cell .expired {
      color: #dc2626;
      font-size: 0.8125rem;
    }
    .validity-cell .valid {
      color: #059669;
      font-size: 0.8125rem;
    }
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-badge.active { background: #dcfce7; color: #166534; }
    .status-badge.inactive { background: #fee2e2; color: #991b1b; }
    .actions {
      display: flex;
      gap: 0.5rem;
    }
    .btn-icon {
      padding: 0.375rem;
      background: transparent;
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-icon:hover {
      background: #f3f4f6;
    }
    .btn-icon svg {
      width: 16px;
      height: 16px;
      color: #6b7280;
    }
    .btn-icon.delete-btn:hover {
      background: #fef2f2;
      border-color: #fecaca;
    }
    .btn-icon.delete-btn:hover svg {
      color: #dc2626;
    }
    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      background: var(--ubikala-olive, #5C6B3C);
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-primary:hover { background: var(--ubikala-olive-dark, #4A5730); }
    .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }
    .btn-primary svg { width: 18px; height: 18px; }
    .btn-outline {
      padding: 0.625rem 1.25rem;
      background: white;
      color: #374151;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
    }
    .btn-outline:hover { background: #f3f4f6; }
    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal.hidden { display: none; }
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      position: relative;
      background: white;
      border-radius: 0.75rem;
      max-width: 550px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 1.5rem;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .modal-header h3 {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #6b7280;
      cursor: pointer;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    @media (max-width: 500px) {
      .form-row { grid-template-columns: 1fr; }
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.375rem;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.625rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 0.875rem;
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--ubikala-olive, #5C6B3C);
    }
    .hint {
      display: block;
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 0.25rem;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.875rem;
      color: #374151;
      cursor: pointer;
    }
    .checkbox-label input {
      width: auto;
    }
    .form-message {
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }
    .form-message.hidden { display: none; }
    .form-message.success { background: #dcfce7; color: #166534; }
    .form-message.error { background: #fef2f2; color: #dc2626; }
    .modal-footer {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      padding-top: 1rem;
      border-top: 1px solid #e5e7eb;
    }
  </style>

  <div id="promo-data" data-json={JSON.stringify(promoCodes)} hidden></div>
  <script>
    const promoData = JSON.parse(document.getElementById('promo-data')!.getAttribute('data-json')!);
    const modal = document.getElementById('promo-modal');
    const form = document.getElementById('promo-form') as HTMLFormElement;
    const modalTitle = document.getElementById('modal-title');
    const promoIdInput = document.getElementById('promo-id') as HTMLInputElement;
    const codeInput = document.getElementById('promo-code-input') as HTMLInputElement;
    const typeSelect = document.getElementById('promo-type') as HTMLSelectElement;
    const valueInput = document.getElementById('promo-value') as HTMLInputElement;
    const maxUsesInput = document.getElementById('promo-max-uses') as HTMLInputElement;
    const descInput = document.getElementById('promo-description') as HTMLInputElement;
    const validFromInput = document.getElementById('promo-valid-from') as HTMLInputElement;
    const validUntilInput = document.getElementById('promo-valid-until') as HTMLInputElement;
    const activeCheckbox = document.getElementById('promo-active') as HTMLInputElement;
    const valueHint = document.getElementById('value-hint');
    const formMessage = document.getElementById('form-message');
    const saveBtn = document.getElementById('save-btn') as HTMLButtonElement;

    const hints: Record<string, string> = {
      percentage: 'Ingresa el porcentaje de descuento (ej: 20 para 20%)',
      fixed: 'Ingresa el monto de descuento (ej: 50 para $50)',
      trial_days: 'Ingresa el número de días de prueba gratis',
      free_months: 'Ingresa el número de meses gratis'
    };
    typeSelect?.addEventListener('change', () => {
      if (valueHint) valueHint.textContent = hints[typeSelect.value] || '';
    });

    // Open modal for new promo
    document.getElementById('new-promo-btn')?.addEventListener('click', () => {
      resetForm();
      if (modalTitle) modalTitle.textContent = 'Nuevo Código Promocional';
      modal?.classList.remove('hidden');
    });

    // Edit promo
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        const promo = promoData.find((p: any) => p.id === id);
        if (!promo) return;

        if (modalTitle) modalTitle.textContent = 'Editar Código Promocional';
        promoIdInput.value = promo.id;
        codeInput.value = promo.code;
        typeSelect.value = promo.discount_type;
        valueInput.value = promo.discount_value;
        maxUsesInput.value = promo.max_uses || '';
        descInput.value = promo.description || '';
        validFromInput.value = promo.valid_from ? promo.valid_from.split('T')[0] : '';
        validUntilInput.value = promo.valid_until ? promo.valid_until.split('T')[0] : '';
        activeCheckbox.checked = promo.is_active;

        document.querySelectorAll<HTMLInputElement>('input[name="roles"]').forEach(cb => {
          cb.checked = promo.applicable_roles?.includes(cb.value) || false;
        });

        modal?.classList.remove('hidden');
      });
    });

    // Delete promo
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('¿Estás seguro de eliminar este código promocional?')) return;
        const id = btn.getAttribute('data-id');
        try {
          const response = await fetch(`/api/admin/promo-codes/${id}`, { method: 'DELETE' });
          if (!response.ok) throw new Error('Error al eliminar');
          window.location.reload();
        } catch (error) {
          alert('Error al eliminar el código promocional');
        }
      });
    });

    // Close modal
    document.getElementById('close-modal')?.addEventListener('click', closeModal);
    document.getElementById('cancel-btn')?.addEventListener('click', closeModal);
    document.querySelector('.modal-backdrop')?.addEventListener('click', closeModal);

    function closeModal() {
      modal?.classList.add('hidden');
      resetForm();
    }

    function resetForm() {
      form?.reset();
      promoIdInput.value = '';
      formMessage?.classList.add('hidden');
      document.querySelectorAll<HTMLInputElement>('input[name="roles"]').forEach(cb => cb.checked = false);
    }

    // Submit form
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      formMessage?.classList.add('hidden');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Guardando...';

      const selectedRoles: string[] = [];
      document.querySelectorAll<HTMLInputElement>('input[name="roles"]:checked').forEach(cb => {
        selectedRoles.push(cb.value);
      });

      const data = {
        code: codeInput.value,
        discount_type: typeSelect.value,
        discount_value: parseFloat(valueInput.value),
        max_uses: maxUsesInput.value ? parseInt(maxUsesInput.value) : null,
        description: descInput.value || null,
        valid_from: validFromInput.value || null,
        valid_until: validUntilInput.value || null,
        applicable_roles: selectedRoles.length > 0 ? selectedRoles : null,
        is_active: activeCheckbox.checked,
      };

      const isEdit = !!promoIdInput.value;
      const url = isEdit ? `/api/admin/promo-codes/${promoIdInput.value}` : '/api/admin/promo-codes';
      const method = isEdit ? 'PUT' : 'POST';

      try {
        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'Error al guardar');

        window.location.reload();
      } catch (error: any) {
        if (formMessage) {
          formMessage.textContent = error.message;
          formMessage.className = 'form-message error';
        }
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Guardar';
      }
    });
  </script>
</AdminLayout>
