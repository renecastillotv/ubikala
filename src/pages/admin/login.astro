---
import { getTokenFromRequest, getCurrentUser } from '../../lib/auth';

// If already logged in, redirect to dashboard
const token = getTokenFromRequest(Astro.request);
if (token) {
  const user = await getCurrentUser(token);
  if (user) {
    return Astro.redirect('/admin/dashboard');
  }
}
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Iniciar Sesión | Ubíkala Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=block" rel="stylesheet" />
    <style>
      /* Ubikala Color Palette */
      :root {
        --ubikala-olive: #5C6B3C;
        --ubikala-olive-dark: #4A5730;
        --ubikala-olive-light: #7A8B5A;
        --ubikala-sand: #D4C4A8;
        --ubikala-sand-light: #E8DFD0;
        --ubikala-terracotta: #C96D3D;
        --ubikala-terracotta-dark: #A85A30;
        --ubikala-ivory: #FAF7F0;
        --ubikala-ivory-pure: #FFFEF9;
        --ubikala-warm-gray: #6B6660;
        --ubikala-warm-gray-dark: #4A4642;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, var(--ubikala-olive) 0%, var(--ubikala-olive-dark) 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      .login-container {
        background: var(--ubikala-ivory-pure);
        border-radius: 1rem;
        box-shadow: 0 25px 50px -12px rgba(74, 87, 48, 0.35);
        width: 100%;
        max-width: 420px;
        padding: 2.5rem;
      }
      .logo {
        text-align: center;
        margin-bottom: 2rem;
      }
      .logo-brand {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }
      .logo-isotipo {
        width: 48px;
        height: 48px;
        object-fit: contain;
      }
      .logo h1 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--ubikala-olive);
        letter-spacing: -0.03em;
      }
      .logo p {
        color: var(--ubikala-warm-gray);
        font-size: 0.875rem;
      }
      .form-group {
        margin-bottom: 1.25rem;
      }
      label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--ubikala-warm-gray-dark);
        margin-bottom: 0.5rem;
      }
      input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--ubikala-sand);
        border-radius: 0.5rem;
        font-size: 1rem;
        background: white;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      input:focus {
        outline: none;
        border-color: var(--ubikala-olive);
        box-shadow: 0 0 0 3px rgba(92, 107, 60, 0.15);
      }
      .btn {
        width: 100%;
        padding: 0.875rem;
        background: var(--ubikala-olive);
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn:hover {
        background: var(--ubikala-olive-dark);
        transform: translateY(-1px);
        box-shadow: 0 10px 25px -5px rgba(92, 107, 60, 0.4);
      }
      .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
      }
      .error-message {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        margin-bottom: 1.25rem;
        display: none;
      }
      .back-link {
        display: block;
        text-align: center;
        margin-top: 1.5rem;
        color: var(--ubikala-warm-gray);
        text-decoration: none;
        font-size: 0.875rem;
        transition: color 0.2s;
      }
      .back-link:hover {
        color: var(--ubikala-olive);
      }
    </style>
  </head>
  <body>
    <div class="login-container">
      <div class="logo">
        <div class="logo-brand">
          <img src="/images/ubikala-isotipo.png" alt="Ubikala" class="logo-isotipo" />
          <h1>Ubíkala</h1>
        </div>
        <p>Panel de Administración</p>
      </div>

      <div id="error-message" class="error-message"></div>

      <form id="login-form">
        <div class="form-group">
          <label for="email">Correo Electrónico</label>
          <input type="email" id="email" name="email" required placeholder="admin@ubikala.com" />
        </div>

        <div class="form-group">
          <label for="password">Contraseña</label>
          <input type="password" id="password" name="password" required placeholder="••••••••" />
        </div>

        <button type="submit" class="btn" id="submit-btn">
          Iniciar Sesión
        </button>
      </form>

      <a href="/" class="back-link">← Volver al portal</a>
    </div>

    <script>
      const form = document.getElementById('login-form') as HTMLFormElement;
      const errorMessage = document.getElementById('error-message') as HTMLDivElement;
      const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = (document.getElementById('email') as HTMLInputElement).value;
        const password = (document.getElementById('password') as HTMLInputElement).value;

        submitBtn.disabled = true;
        submitBtn.textContent = 'Iniciando sesión...';
        errorMessage.style.display = 'none';

        try {
          const response = await fetch('/api/admin/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'Error al iniciar sesión');
          }

          window.location.href = '/admin/dashboard';
        } catch (error: any) {
          errorMessage.textContent = error.message;
          errorMessage.style.display = 'block';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Iniciar Sesión';
        }
      });
    </script>
  </body>
</html>
