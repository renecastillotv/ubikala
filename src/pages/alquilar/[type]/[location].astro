---
import Layout from '../../../layouts/Layout.astro';
import PropertyCard from '../../../components/PropertyCard.astro';
import SearchBox from '../../../components/SearchBox.astro';
import Pagination from '../../../components/Pagination.astro';
import Breadcrumb from '../../../components/Breadcrumb.astro';
import { useTranslations } from '../../../i18n';
import { searchProperties } from '../../../lib/meilisearch';
import type { Property } from '../../../data/types';

// SSR para rutas din√°micas
export const prerender = false;

const { type: typeSlug, location: locationSlug } = Astro.params;
const t = useTranslations('es');

// Mapeo de slugs de tipo a valores de BD y nombres legibles
const propertyTypeMap: Record<string, { dbValue: string; singular: string; plural: string; icon: string }> = {
  'apartamento': { dbValue: 'apartamento', singular: 'Apartamento', plural: 'Apartamentos', icon: 'üè¢' },
  'apartamentos': { dbValue: 'apartamento', singular: 'Apartamento', plural: 'Apartamentos', icon: 'üè¢' },
  'casa': { dbValue: 'casa', singular: 'Casa', plural: 'Casas', icon: 'üè†' },
  'casas': { dbValue: 'casa', singular: 'Casa', plural: 'Casas', icon: 'üè†' },
  'villa': { dbValue: 'villa', singular: 'Villa', plural: 'Villas', icon: 'üè°' },
  'villas': { dbValue: 'villa', singular: 'Villa', plural: 'Villas', icon: 'üè°' },
  'penthouse': { dbValue: 'penthouse', singular: 'Penthouse', plural: 'Penthouses', icon: 'üåÜ' },
  'penthouses': { dbValue: 'penthouse', singular: 'Penthouse', plural: 'Penthouses', icon: 'üåÜ' },
  'local': { dbValue: 'local comercial', singular: 'Local Comercial', plural: 'Locales Comerciales', icon: 'üè™' },
  'local-comercial': { dbValue: 'local comercial', singular: 'Local Comercial', plural: 'Locales Comerciales', icon: 'üè™' },
  'locales': { dbValue: 'local comercial', singular: 'Local Comercial', plural: 'Locales Comerciales', icon: 'üè™' },
  'oficina': { dbValue: 'oficina', singular: 'Oficina', plural: 'Oficinas', icon: 'üèõÔ∏è' },
  'oficinas': { dbValue: 'oficina', singular: 'Oficina', plural: 'Oficinas', icon: 'üèõÔ∏è' },
  'nave': { dbValue: 'nave', singular: 'Nave Industrial', plural: 'Naves Industriales', icon: 'üè≠' },
  'naves': { dbValue: 'nave', singular: 'Nave Industrial', plural: 'Naves Industriales', icon: 'üè≠' },
  'estudio': { dbValue: 'estudio', singular: 'Estudio', plural: 'Estudios', icon: 'üõèÔ∏è' },
  'estudios': { dbValue: 'estudio', singular: 'Estudio', plural: 'Estudios', icon: 'üõèÔ∏è' },
};

// Validar tipo de propiedad
const typeInfo = propertyTypeMap[typeSlug?.toLowerCase() || ''];
if (!typeInfo) {
  return Astro.redirect('/alquilar');
}

// Formatear nombre de ubicaci√≥n desde slug
const formatLocationName = (slug: string) => {
  return slug
    .replace(/-/g, ' ')
    .replace(/\b\w/g, l => l.toUpperCase());
};

const locationName = formatLocationName(locationSlug || '');

// Configuraci√≥n de paginaci√≥n
const ITEMS_PER_PAGE = 24;
const currentPage = Math.max(1, parseInt(Astro.url.searchParams.get('page') || '1'));

// Intentar obtener info de ubicaci√≥n
let locationData: { name: string; province: string } = {
  name: locationName,
  province: 'Rep√∫blica Dominicana'
};

const pais = Astro.locals.country.name;

// Fetch properties con filtros de tipo y ubicaci√≥n via MeiliSearch
let properties: Property[] = [];
let totalCount = 0;

try {
  const offset = (currentPage - 1) * ITEMS_PER_PAGE;

  const result = await searchProperties({
    operacion: 'renta',
    tipo: typeInfo.dbValue,
    query: locationSlug?.replace(/-/g, ' '),
    limit: ITEMS_PER_PAGE,
    offset,
    pais,
  });

  properties = result.properties;
  totalCount = result.total;

  // Update location data from first property if available
  if (properties.length > 0) {
    const firstProp = properties[0];
    if (firstProp.location.city) {
      locationData.name = firstProp.location.city;
    }
    if (firstProp.location.province) {
      locationData.province = firstProp.location.province;
    }
  }
} catch (error) {
  console.error('Error fetching properties:', error);
}

const totalPages = Math.ceil(totalCount / ITEMS_PER_PAGE);

if (currentPage > totalPages && totalPages > 0) {
  return Astro.redirect(`/alquilar/${typeSlug}/${locationSlug}`);
}

// T√≠tulos y descripciones din√°micas para SEO
const pageTitle = `${typeInfo.plural} en Alquiler en ${locationData.name} | Ub√≠kala`;
const pageDescription = `Encuentra ${typeInfo.plural.toLowerCase()} en alquiler en ${locationData.name}, ${locationData.province}. ${totalCount} propiedades disponibles con fotos, precios y contacto directo.`;

// Contenido SEO espec√≠fico para alquileres
const seoContent: Record<string, { intro: string; requirements: string[]; tips: string[] }> = {
  'apartamento': {
    intro: `Alquilar un apartamento en ${locationData.name} te ofrece flexibilidad sin el compromiso de una compra. Ideal para profesionales, parejas y familias que buscan comodidad con amenidades modernas.`,
    requirements: [
      'C√©dula o pasaporte vigente',
      'Carta de trabajo o constancia de ingresos',
      'Referencias personales o de alquiler anterior',
      'Dep√≥sito de 1-2 meses de renta'
    ],
    tips: [
      'Verifica qu√© servicios est√°n incluidos en la renta',
      'Pregunta por la pol√≠tica de mascotas si tienes',
      'Revisa el contrato antes de firmar',
      'Documenta el estado del apartamento al entrar'
    ]
  },
  'casa': {
    intro: `Las casas en alquiler en ${locationData.name} ofrecen m√°s espacio y privacidad que los apartamentos. Son ideales para familias que necesitan patio, estacionamiento y habitaciones adicionales.`,
    requirements: [
      'C√©dula o pasaporte vigente',
      'Comprobante de ingresos (3x el monto del alquiler)',
      'Referencias de propietarios anteriores',
      'Dep√≥sito de seguridad (1-3 meses)'
    ],
    tips: [
      'Pregunta qui√©n paga el mantenimiento del jard√≠n',
      'Verifica el estado de techos, plomer√≠a y electricidad',
      'Confirma los costos de servicios (agua, luz, gas)',
      'Revisa la seguridad del sector'
    ]
  },
  'oficina': {
    intro: `Alquilar una oficina en ${locationData.name} te permite establecer tu negocio en una ubicaci√≥n estrat√©gica. Considera factores como acceso, estacionamiento y servicios cercanos.`,
    requirements: [
      'Documentos de la empresa (RNC, registro mercantil)',
      'Estados financieros o carta bancaria',
      'Referencias comerciales',
      'Dep√≥sito de garant√≠a'
    ],
    tips: [
      'Verifica el acceso a internet de alta velocidad',
      'Pregunta por espacios de estacionamiento incluidos',
      'Revisa horarios de acceso al edificio',
      'Considera la imagen del edificio para tu negocio'
    ]
  },
  'default': {
    intro: `Encuentra ${typeInfo.plural.toLowerCase()} en alquiler en ${locationData.name} con las mejores condiciones. Nuestro directorio te conecta directamente con propietarios y asesores verificados.`,
    requirements: [
      'Documento de identidad vigente',
      'Comprobante de ingresos',
      'Referencias personales o laborales',
      'Dep√≥sito de seguridad'
    ],
    tips: [
      'Visita la propiedad antes de comprometerte',
      'Lee el contrato completo antes de firmar',
      'Documenta el estado actual con fotos',
      'Pregunta por todos los costos adicionales'
    ]
  }
};

const contentKey = seoContent[typeInfo.dbValue] ? typeInfo.dbValue : 'default';
const locationContent = seoContent[contentKey];

// FAQs din√°micas
const dynamicFAQs = [
  {
    question: `¬øCu√°nto cuesta alquilar un ${typeInfo.singular.toLowerCase()} en ${locationData.name}?`,
    answer: `Los precios de alquiler de ${typeInfo.plural.toLowerCase()} en ${locationData.name} var√≠an seg√∫n ubicaci√≥n, tama√±o y amenidades. Actualmente tenemos ${totalCount} opciones disponibles. Los precios pueden ir desde estudios econ√≥micos hasta propiedades de lujo. Te recomendamos explorar el listado para ver opciones en tu rango de presupuesto.`
  },
  {
    question: `¬øQu√© documentos necesito para alquilar en ${locationData.name}?`,
    answer: `Generalmente necesitas: c√©dula o pasaporte, carta de trabajo o comprobante de ingresos, referencias personales o de alquileres anteriores, y el dep√≥sito de seguridad (usualmente 1-2 meses). Algunos propietarios pueden solicitar fiador o garant√≠a adicional.`
  },
  {
    question: `¬øPuedo alquilar siendo extranjero en ${locationData.name}?`,
    answer: `S√≠, los extranjeros pueden alquilar propiedades en Rep√∫blica Dominicana. Necesitar√°s tu pasaporte vigente, comprobante de ingresos o carta de trabajo, y posiblemente un dep√≥sito mayor o fiador local seg√∫n el propietario.`
  },
  {
    question: `¬øLos servicios est√°n incluidos en el alquiler?`,
    answer: `Depende de cada propiedad. Algunos alquileres incluyen agua, internet o mantenimiento de √°reas comunes. Siempre pregunta espec√≠ficamente qu√© est√° incluido y cu√°les son los costos estimados de servicios no incluidos antes de firmar el contrato.`
  }
];

// Schema para SEO
const listingSchema = {
  '@context': 'https://schema.org',
  '@type': 'ItemList',
  name: `${typeInfo.plural} en Alquiler en ${locationData.name}`,
  description: pageDescription,
  numberOfItems: totalCount,
  itemListElement: properties.slice(0, 10).map((property, index) => ({
    '@type': 'ListItem',
    position: index + 1,
    item: {
      '@type': 'RealEstateListing',
      name: property.title,
      description: property.description.substring(0, 160),
      url: `https://ubikala.com/propiedad/${property.slug}`,
      image: property.images[0]?.url,
      offers: {
        '@type': 'Offer',
        price: property.price,
        priceCurrency: property.currency,
      },
    },
  })),
};

const faqSchema = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: dynamicFAQs.map(faq => ({
    '@type': 'Question',
    name: faq.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: faq.answer
    }
  }))
};

// Tipos relacionados para sugerencias
const relatedTypes = Object.entries(propertyTypeMap)
  .filter(([slug, info]) => info.dbValue !== typeInfo.dbValue && !slug.endsWith('s'))
  .slice(0, 4)
  .map(([slug, info]) => ({ slug, ...info }));
---

<Layout
  title={pageTitle}
  description={pageDescription}
  keywords={`${typeInfo.plural.toLowerCase()} alquiler ${locationData.name.toLowerCase()}, rentar ${typeInfo.singular.toLowerCase()} ${locationData.name.toLowerCase()}, ${typeInfo.plural.toLowerCase()} renta ${locationData.name.toLowerCase()}`}
>
  <script type="application/ld+json" set:html={JSON.stringify(listingSchema)} slot="head" />
  <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} slot="head" />

  <Breadcrumb items={[
    { label: 'Inicio', href: '/' },
    { label: 'Alquilar', href: '/alquilar' },
    { label: typeInfo.plural, href: `/alquilar?tipo=${typeInfo.dbValue}` },
    { label: locationData.name }
  ]} />

  <!-- Hero -->
  <section class="bg-gradient-to-r from-secondary-600 to-secondary-700 py-12">
    <div class="container-custom">
      <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">
        {typeInfo.plural} en Alquiler en {locationData.name}
      </h1>
      <p class="text-secondary-100 text-lg max-w-3xl">
        {totalCount > 0
          ? `Explora ${totalCount} ${typeInfo.plural.toLowerCase()} disponibles para alquiler en ${locationData.name}, ${locationData.province}.`
          : `Actualmente no hay ${typeInfo.plural.toLowerCase()} en alquiler en ${locationData.name}. Explora otras zonas o tipos de propiedad.`
        }
      </p>
    </div>
  </section>

  <!-- Search -->
  <section class="py-6 bg-white shadow-sm sticky top-16 z-40">
    <div class="container-custom">
      <SearchBox />
    </div>
  </section>

  <!-- Results or Empty State -->
  <section class="section">
    <div class="container-custom">
      {properties.length > 0 ? (
        <>
          <div class="flex items-center justify-between mb-8">
            <p class="text-gray-600">
              <span class="font-semibold text-gray-900">{totalCount}</span> {typeInfo.plural.toLowerCase()} en alquiler
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {properties.map((property) => (
              <PropertyCard property={property} />
            ))}
          </div>

          {totalPages > 1 && (
            <div class="mt-12">
              <Pagination currentPage={currentPage} totalPages={totalPages} baseUrl={`/alquilar/${typeSlug}/${locationSlug}`} />
            </div>
          )}
        </>
      ) : (
        <div class="text-center py-16">
          <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-gray-900 mb-4">
            No encontramos {typeInfo.plural.toLowerCase()} en alquiler en {locationData.name}
          </h2>
          <p class="text-gray-600 mb-8 max-w-md mx-auto">
            Actualmente no hay {typeInfo.plural.toLowerCase()} disponibles en esta zona. Prueba con otra ubicaci√≥n o tipo de propiedad.
          </p>
          <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="/alquilar" class="bg-secondary-600 text-white hover:bg-secondary-700 font-semibold px-6 py-3 rounded-lg transition-colors">
              Ver Todas las Propiedades
            </a>
            <a href={`/propiedades/${locationSlug}`} class="btn-outline">
              Ver Todo en {locationData.name}
            </a>
          </div>
        </div>
      )}
    </div>
  </section>

  <!-- SEO Content Section -->
  <section class="py-16 bg-gray-50">
    <div class="container-custom">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">
          Alquilar {typeInfo.plural} en {locationData.name}
        </h2>

        <p class="text-gray-600 text-lg mb-8">
          {locationContent.intro}
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
          <!-- Requisitos -->
          <div class="bg-white rounded-xl p-6 shadow-sm">
            <h3 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
              <svg class="w-5 h-5 text-secondary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              Requisitos Comunes
            </h3>
            <ul class="space-y-3">
              {locationContent.requirements.map((req) => (
                <li class="flex items-start gap-2 text-gray-600">
                  <svg class="w-5 h-5 text-secondary-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  {req}
                </li>
              ))}
            </ul>
          </div>

          <!-- Tips -->
          <div class="bg-white rounded-xl p-6 shadow-sm">
            <h3 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
              <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Consejos para Alquilar
            </h3>
            <ul class="space-y-3">
              {locationContent.tips.map((tip) => (
                <li class="flex items-start gap-2 text-gray-600">
                  <svg class="w-5 h-5 text-primary-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                  {tip}
                </li>
              ))}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- FAQs -->
  <section class="py-16">
    <div class="container-custom">
      <h2 class="text-2xl md:text-3xl font-bold text-gray-900 text-center mb-4">
        Preguntas Frecuentes
      </h2>
      <p class="text-gray-600 text-center max-w-2xl mx-auto mb-12">
        Resolvemos tus dudas sobre alquilar {typeInfo.plural.toLowerCase()} en {locationData.name}
      </p>

      <div class="max-w-3xl mx-auto space-y-4">
        {dynamicFAQs.map((faq) => (
          <details class="bg-white rounded-xl shadow-sm group">
            <summary class="flex items-center justify-between p-6 cursor-pointer">
              <span class="font-semibold text-gray-900 pr-4">{faq.question}</span>
              <svg class="w-5 h-5 text-gray-500 group-open:rotate-180 transition-transform flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </summary>
            <div class="px-6 pb-6 text-gray-600">
              {faq.answer}
            </div>
          </details>
        ))}
      </div>
    </div>
  </section>

  <!-- Otros tipos de propiedad -->
  <section class="py-16 bg-gray-50">
    <div class="container-custom">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">
        Otros Tipos de Propiedad en Alquiler en {locationData.name}
      </h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        {relatedTypes.map((type) => (
          <a
            href={`/alquilar/${type.slug}/${locationSlug}`}
            class="bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow text-center group"
          >
            <span class="text-3xl block mb-2">{type.icon}</span>
            <span class="font-semibold text-gray-900 group-hover:text-secondary-600">
              {type.plural}
            </span>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="py-16 bg-gradient-to-r from-secondary-600 to-secondary-700">
    <div class="container-custom">
      <div class="max-w-3xl mx-auto text-center">
        <h2 class="text-3xl font-bold text-white mb-4">
          ¬øNecesitas ayuda para encontrar tu {typeInfo.singular.toLowerCase()}?
        </h2>
        <p class="text-secondary-100 text-lg mb-8">
          Nuestros asesores conocen {locationData.name} y pueden ayudarte a encontrar la propiedad perfecta para alquilar.
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a href="/asesores" class="bg-white text-secondary-600 hover:bg-secondary-50 font-semibold px-8 py-3 rounded-lg transition-colors">
            Contactar un Asesor
          </a>
          <a href="/alquilar" class="border-2 border-white text-white hover:bg-white/10 font-semibold px-8 py-3 rounded-lg transition-colors">
            Ver M√°s Propiedades
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Links Relacionados -->
  <section class="py-12">
    <div class="container-custom">
      <h2 class="text-xl font-bold text-gray-900 mb-6">Enlaces Relacionados</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <a href={`/propiedades/${locationSlug}`} class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors group">
          <div class="w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            </svg>
          </div>
          <div>
            <span class="font-semibold text-gray-900 group-hover:text-primary-600">Todo en {locationData.name}</span>
            <p class="text-sm text-gray-500">Todas las propiedades</p>
          </div>
        </a>

        <a href={`/comprar/${typeSlug}/${locationSlug}`} class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors group">
          <div class="w-10 h-10 bg-secondary-100 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 text-secondary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
          </div>
          <div>
            <span class="font-semibold text-gray-900 group-hover:text-primary-600">Comprar en {locationData.name}</span>
            <p class="text-sm text-gray-500">{typeInfo.plural} en venta</p>
          </div>
        </a>

        <a href="/asesores" class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors group">
          <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </div>
          <div>
            <span class="font-semibold text-gray-900 group-hover:text-primary-600">Asesores Inmobiliarios</span>
            <p class="text-sm text-gray-500">Contacta un experto</p>
          </div>
        </a>
      </div>
    </div>
  </section>
</Layout>
