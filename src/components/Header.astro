---
import Icon from './Icons.astro';
import { getLangFromUrl, useTranslations, localizedUrl, languages, getLanguageUrls, type Lang } from '../i18n';
import { getSiteConfig } from '../lib/config';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Fetch site config
const config = await getSiteConfig();

// Generar URLs traducidas para cada idioma
const languageUrls = getLanguageUrls(Astro.url.pathname);

// Get authenticated user from middleware
const user = Astro.locals.user;
const isLoggedIn = !!user;
---

<header class="bg-white shadow-sm sticky top-0 z-50">
  <!-- Top bar - Olive green -->
  <div class="bg-primary-700 text-white text-sm py-2">
    <div class="container-custom flex justify-between items-center">
      <div class="flex items-center gap-4">
        <a href={`tel:${config.phone}`} class="flex items-center gap-1 hover:text-primary-200">
          <Icon name="phone" class="w-4 h-4" />
          <span class="hidden sm:inline">{config.phone_display}</span>
        </a>
        <a href={`mailto:${config.email}`} class="hidden md:flex items-center gap-1 hover:text-primary-200">
          <Icon name="email" class="w-4 h-4" />
          <span>{config.email}</span>
        </a>
      </div>
      <div class="flex items-center gap-3">
        <!-- Claim -->
        <span class="hidden md:inline text-primary-100 text-xs">Esa propiedad que buscas, ubíkala aquí</span>
        <!-- Language Switcher -->
        <div class="flex items-center gap-1 border-l border-primary-500 pl-3">
          {Object.entries(languages).map(([langCode, langName]) => (
            <a
              href={languageUrls[langCode as Lang]}
              class={`px-2 py-1 rounded text-xs font-medium transition-colors ${
                lang === langCode
                  ? 'bg-primary-600 text-white'
                  : 'hover:bg-primary-600 text-primary-200'
              }`}
              title={langName}
            >
              {langCode.toUpperCase()}
            </a>
          ))}
        </div>
      </div>
    </div>
  </div>

  <!-- Main Navigation -->
  <nav class="container-custom">
    <div class="flex items-center justify-between h-16 lg:h-20">
      <!-- Logo - Ubikala -->
      <a href={localizedUrl('/', lang)} class="flex items-center gap-2">
        <img
          src="/images/ubikala-isotipo.png"
          alt="Ubikala"
          class="w-10 h-10 object-contain"
          width="40"
          height="40"
        />
        <div class="hidden sm:block">
          <span class="text-2xl font-bold text-primary-700 tracking-tight">Ub&iacute;kala</span>
          <span class="text-xs text-gray-500 block -mt-1">.com</span>
        </div>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden lg:flex items-center gap-8">
        <a href={localizedUrl('/comprar', lang)} class="text-gray-700 hover:text-primary-600 font-medium">
          {t.nav.buy}
        </a>
        <a href={localizedUrl('/alquilar', lang)} class="text-gray-700 hover:text-primary-600 font-medium">
          {t.nav.rent}
        </a>
        <a href={localizedUrl('/asesores', lang)} class="text-gray-700 hover:text-primary-600 font-medium">
          {t.nav.agents}
        </a>
        <a href={localizedUrl('/inmobiliarias', lang)} class="text-gray-700 hover:text-primary-600 font-medium">
          {t.nav.realEstate}
        </a>
        <a href={localizedUrl('/nosotros', lang)} class="text-gray-700 hover:text-primary-600 font-medium">
          {t.nav.about}
        </a>
        <a href={localizedUrl('/contacto', lang)} class="text-gray-700 hover:text-primary-600 font-medium">
          {t.nav.contact}
        </a>
      </div>

      <!-- CTA Buttons -->
      <div class="flex items-center gap-3">
        <!-- Favorites Button -->
        <a
          href={localizedUrl('/favoritos', lang)}
          class="relative p-2 text-gray-400 hover:text-primary-600 transition-colors"
          title="Guardados"
        >
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
          </svg>
          <span
            data-favorites-count
            class="absolute -top-0.5 -right-0.5 w-4 h-4 bg-accent-600 text-white text-[10px] font-bold rounded-full flex items-center justify-center hidden"
          >0</span>
        </a>

        {isLoggedIn ? (
          <!-- Logged in: Show publish and profile -->
          <a href="/admin/properties/create" class="hidden sm:inline-flex btn-primary text-sm">
            {t.nav.publishProperty}
          </a>
          <a href="/admin/dashboard" class="hidden md:flex items-center gap-2 text-gray-700 hover:text-primary-600 font-medium">
            <span class="w-8 h-8 bg-primary-600 text-white rounded-full flex items-center justify-center text-sm font-semibold">
              {user?.name?.charAt(0).toUpperCase()}
            </span>
            <span class="hidden lg:inline">{user?.name?.split(' ')[0]}</span>
          </a>
        ) : (
          <!-- Not logged in: Show publish and login -->
          <a href="/publicar" class="hidden sm:inline-flex btn-primary text-sm">
            {t.nav.publishProperty}
          </a>
          <a href="/admin/login" class="text-gray-700 hover:text-primary-600 font-medium hidden md:block">
            {t.nav.login}
          </a>
        )}

        <!-- Mobile Menu Button -->
        <button
          id="mobile-menu-button"
          class="lg:hidden p-2 text-gray-700 hover:text-primary-600"
          aria-label="Menu"
        >
          <Icon name="menu" class="w-6 h-6" />
        </button>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-menu" class="lg:hidden hidden pb-4">
      <div class="flex flex-col gap-2">
        <a href={localizedUrl('/comprar', lang)} class="px-4 py-2 text-gray-700 hover:bg-secondary-200 rounded-lg">
          {t.nav.buy}
        </a>
        <a href={localizedUrl('/alquilar', lang)} class="px-4 py-2 text-gray-700 hover:bg-secondary-200 rounded-lg">
          {t.nav.rent}
        </a>
        <a href={localizedUrl('/asesores', lang)} class="px-4 py-2 text-gray-700 hover:bg-secondary-200 rounded-lg">
          {t.nav.agents}
        </a>
        <a href={localizedUrl('/inmobiliarias', lang)} class="px-4 py-2 text-gray-700 hover:bg-secondary-200 rounded-lg">
          {t.nav.realEstate}
        </a>
        <a href={localizedUrl('/nosotros', lang)} class="px-4 py-2 text-gray-700 hover:bg-secondary-200 rounded-lg">
          {t.nav.about}
        </a>
        <a href={localizedUrl('/contacto', lang)} class="px-4 py-2 text-gray-700 hover:bg-secondary-200 rounded-lg">
          {t.nav.contact}
        </a>
        <a href={localizedUrl('/favoritos', lang)} class="px-4 py-2 text-gray-700 hover:bg-secondary-200 rounded-lg flex items-center gap-2">
          <svg class="w-4 h-4 text-primary-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
          </svg>
          Guardados
          <span data-favorites-count class="ml-auto bg-primary-100 text-primary-700 text-xs font-medium px-2 py-0.5 rounded-full hidden">0</span>
        </a>
        <hr class="my-2 border-secondary-400" />
        {isLoggedIn ? (
          <a href="/admin/properties/create" class="btn-primary text-center">
            {t.nav.publishProperty}
          </a>
          <a href="/admin/dashboard" class="btn-outline text-center flex items-center justify-center gap-2">
            <span class="w-6 h-6 bg-primary-600 text-white rounded-full flex items-center justify-center text-xs font-semibold">
              {user?.name?.charAt(0).toUpperCase()}
            </span>
            Mi Panel
          </a>
        ) : (
          <a href="/publicar" class="btn-primary text-center">
            {t.nav.publishProperty}
          </a>
          <a href="/admin/login" class="btn-outline text-center">
            {t.nav.login}
          </a>
        )}
      </div>
    </div>
  </nav>
</header>

<script>
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');

  mobileMenuButton?.addEventListener('click', () => {
    mobileMenu?.classList.toggle('hidden');
  });
</script>
