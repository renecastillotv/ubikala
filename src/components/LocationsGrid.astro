---
import { getLangFromUrl, useTranslations, localizedUrl, type Lang } from '../i18n';
import { getLocationsWithStats } from '../lib/meilisearch';

const lang = getLangFromUrl(Astro.url) as Lang;
const t = useTranslations(lang);

// Obtener ubicaciones populares desde MeiliSearch
let locations: Array<{ slug: string; name: string; province: string; propertyCount: number; sampleImage: string | null }> = [];
try {
  locations = await getLocationsWithStats();
} catch (error) {
  console.error('Error fetching location stats:', error);
}

// Imagen placeholder para ubicaciones sin imagen de propiedad
const defaultImage = 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800';

// Tomar las primeras 6 ubicaciones para mostrar
const displayLocations = locations.slice(0, 6);
---

<section class="section">
  <div class="container-custom">
    <div class="text-center mb-12">
      <span class="text-primary-600 font-semibold text-sm uppercase tracking-wider">
        Explora por Ubicación
      </span>
      <h2 class="section-title mt-2">
        Destinos Populares en República Dominicana
      </h2>
      <p class="section-subtitle mx-auto">
        Encuentra propiedades en las ciudades y zonas más buscadas del país
      </p>
    </div>

    {displayLocations.length > 0 ? (
      <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
        {displayLocations.map((location) => (
          <a
            href={localizedUrl(`/propiedades/${location.slug}`, lang)}
            class="group relative overflow-hidden rounded-xl aspect-[4/3]"
          >
            <img
              src={location.sampleImage || defaultImage}
              alt={`Propiedades en ${location.name}`}
              class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
              loading="lazy"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/30 to-transparent"></div>
            <div class="absolute bottom-0 left-0 right-0 p-4">
              <h3 class="text-white font-bold text-lg mb-1">
                {location.name}
              </h3>
              <span class="inline-flex items-center gap-1 text-white text-xs bg-white/20 backdrop-blur-sm px-2 py-1 rounded-full">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                {location.propertyCount} propiedades
              </span>
            </div>
          </a>
        ))}
      </div>
    ) : (
      <div class="text-center py-12">
        <p class="text-gray-600">Cargando ubicaciones...</p>
      </div>
    )}

    <!-- Ver todas las ubicaciones -->
    {locations.length > 6 && (
      <div class="text-center mt-8">
        <a href={localizedUrl('/propiedades', lang)} class="btn-outline">
          Ver todas las ubicaciones
          <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
          </svg>
        </a>
      </div>
    )}
  </div>
</section>
