---
interface Props {
  latitude: number;
  longitude: number;
  title: string;
  address?: string;
  zoom?: number;
  isApproximate?: boolean; // True when using city/sector coords instead of exact property coords
}

const { latitude, longitude, title, address, zoom = 15, isApproximate = false } = Astro.props;

// Check if coordinates are valid
const hasValidCoords = latitude && longitude && latitude !== 0 && longitude !== 0;
---

{hasValidCoords ? (
  <div class="property-map-container relative">
    {isApproximate && (
      <div class="absolute top-3 left-3 z-10 bg-amber-100 text-amber-800 text-xs font-medium px-2.5 py-1 rounded-lg flex items-center gap-1.5 shadow-sm">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Ubicacion aproximada
      </div>
    )}
    <div
      id="property-map"
      class="w-full h-64 md:h-80 rounded-xl overflow-hidden z-0"
      data-lat={latitude}
      data-lng={longitude}
      data-zoom={zoom}
      data-title={title}
      data-address={address}
    ></div>
  </div>
) : (
  <div class="bg-gray-100 rounded-xl h-64 flex items-center justify-center">
    <div class="text-center text-gray-500">
      <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
      <p>Ubicacion no disponible</p>
    </div>
  </div>
)}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<script is:inline>
  document.addEventListener('DOMContentLoaded', function() {
    const mapContainer = document.getElementById('property-map');
    if (!mapContainer) return;

    const lat = parseFloat(mapContainer.dataset.lat);
    const lng = parseFloat(mapContainer.dataset.lng);
    const zoom = parseInt(mapContainer.dataset.zoom) || 15;
    const title = mapContainer.dataset.title;
    const address = mapContainer.dataset.address || '';

    if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) return;

    // Load Leaflet dynamically
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
    script.crossOrigin = '';
    script.onload = function() {
      // Create the map
      const map = L.map('property-map', {
        scrollWheelZoom: false,
        dragging: !L.Browser.mobile
      }).setView([lat, lng], zoom);

      // Add tile layer (OpenStreetMap)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      // Custom marker icon
      const customIcon = L.divIcon({
        className: 'custom-marker',
        html: '<div class="marker-pin"><svg viewBox="0 0 24 24" fill="#0066CC" width="32" height="32"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></div>',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      });

      // Add marker
      const marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);

      // Add popup with property info
      const popupContent = '<div class="p-2"><strong>' + title + '</strong>' + (address ? '<br><span class="text-gray-600 text-sm">' + address + '</span>' : '') + '</div>';
      marker.bindPopup(popupContent);

      // Open popup on load
      marker.openPopup();

      // Enable scroll zoom on click
      map.on('click', function() {
        map.scrollWheelZoom.enable();
      });
    };
    document.head.appendChild(script);
  });
</script>

<style is:global>
  .custom-marker {
    background: transparent;
    border: none;
  }
  .marker-pin {
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
  }
  .leaflet-popup-content-wrapper {
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }
  .leaflet-popup-content {
    margin: 8px 12px;
  }
</style>
