---
import type { Property } from '../data/types';
import { getLangFromUrl, useTranslations, localizedUrl } from '../i18n';

interface Props {
  property: Property;
  priority?: boolean;
}

const { property, priority = false } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get up to 5 images for carousel
const carouselImages = property.images.slice(0, 5);
const hasMultipleImages = carouselImages.length > 1;

function formatPrice(price: number, currency: string): string {
  if (currency === 'DOP') {
    return `RD$${price.toLocaleString('es-DO')}`;
  }
  return `$${price.toLocaleString('en-US')}`;
}

// Generate unique ID for this card
const cardId = `card-${property.slug}`;
const propertyUrl = localizedUrl(`/propiedad/${property.slug}`, lang);

// Build features string
const bedLabel = lang === 'en' ? 'bd' : lang === 'fr' ? 'ch' : 'hab';
const bathLabel = lang === 'en' ? 'ba' : lang === 'fr' ? 'sdb' : (property.bathrooms === 1 ? 'baño' : 'baños');
const parkLabel = lang === 'en' ? 'pkg' : lang === 'fr' ? 'pkg' : 'parq';
const features: string[] = [];
if (property.bedrooms && property.bedrooms > 0) features.push(`${property.bedrooms} ${bedLabel}`);
if (property.bathrooms && property.bathrooms > 0) features.push(`${property.bathrooms} ${bathLabel}`);
if (property.area > 0) features.push(`${property.area}m²`);
if (property.parkingSpaces && property.parkingSpaces > 0) features.push(`${property.parkingSpaces} ${parkLabel}`);
const featuresText = features.join(' · ');

// Format property type using i18n
const typeLabel = t.propertyTypes[property.type as keyof typeof t.propertyTypes] || property.type;
---

<article class="card-property" data-card-id={cardId}>
  <a href={propertyUrl} class="block">
    <!-- Image Section -->
    <div class="card-image-wrap">
      {/* Simple single image for testing */}
      {carouselImages[0] && (
        <img
          src={carouselImages[0].url}
          alt={carouselImages[0].alt || property.title}
          loading={priority ? "eager" : "lazy"}
          class="card-main-image"
        />
      )}

      {/* Carousel for multiple images */}
      {hasMultipleImages && (
        <div class="card-carousel" data-carousel={cardId}>
          {carouselImages.map((img, index) => (
            <img
              src={img.url}
              alt={img.alt || `${property.title} - Imagen ${index + 1}`}
              loading={index === 0 ? "eager" : "lazy"}
              class={`card-slide${index === 0 ? ' active' : ''}`}
              data-slide-index={index}
            />
          ))}
        </div>
      )}

      <!-- Minimal carousel indicators - bottom bar style -->
      {hasMultipleImages && (
        <div class="card-progress">
          {carouselImages.map((_, index) => (
            <span
              class={`progress-segment ${index === 0 ? 'active' : ''}`}
              data-carousel-dot={cardId}
              data-dot-index={index}
            />
          ))}
        </div>
      )}

      <!-- Navigation arrows - only on hover, minimal style -->
      {hasMultipleImages && (
        <>
          <button
            type="button"
            class="card-nav card-nav-prev"
            data-carousel-prev={cardId}
            aria-label="Anterior"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M15 18l-6-6 6-6" />
            </svg>
          </button>
          <button
            type="button"
            class="card-nav card-nav-next"
            data-carousel-next={cardId}
            aria-label="Siguiente"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M9 18l6-6-6-6" />
            </svg>
          </button>
        </>
      )}

      <!-- Agent info overlay on image -->
      {property.agent && (
        <a
          href={localizedUrl(property.agent.isUbikalaUser ? `/usuario/${property.agent.slug}` : `/asesor/${property.agent.slug}`, lang)}
          class="card-agent-overlay"
          onclick="event.stopPropagation();"
        >
          <div class="agent-avatar-wrap">
            <img
              src={property.agent.photo || '/images/agent-placeholder.svg'}
              alt={property.agent.name}
              class="agent-avatar"
              loading="lazy"
            />
            {property.agent.verified && (
              <svg class="agent-badge" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
              </svg>
            )}
          </div>
          <span class="agent-name">
            {property.agent.name}
            {property.agent.parentCompany && (
              <span class="agent-company"> · {property.agent.parentCompany}</span>
            )}
          </span>
        </a>
      )}
    </div>

    <!-- Content Section - Clean layout -->
    <div class="card-content">
      <!-- Price Row -->
      <div class="card-price-row">
        <span class="card-price">
          {formatPrice(property.price, property.currency)}
          {property.transactionType === 'rent' && <span class="price-period">{t.property.pricePerMonth}</span>}
        </span>
        {property.transactionType === 'rent' && (
          <span class="card-tag rent">{t.transactionTypes.rent}</span>
        )}
        {property.isPriceReduced && (
          <span class="card-tag reduced">{t.common.reduced}</span>
        )}
      </div>

      <!-- Title -->
      <h3 class="card-title">{property.title}</h3>

      <!-- Location - simple text, no icon -->
      <p class="card-location">{property.location.sector}, {property.location.city}</p>

      <!-- Features - compact text style -->
      {featuresText && (
        <p class="card-features">{featuresText}</p>
      )}

      <!-- Footer with type and save button -->
      <div class="card-footer">
        <span class="card-type">{typeLabel}</span>

        <!-- Save button - bookmark style, not heart -->
        <button
          type="button"
          data-favorite-btn
          data-property-slug={property.slug}
          data-property-title={property.title}
          data-property-image={carouselImages[0]?.url}
          data-property-price={property.price}
          data-property-currency={property.currency}
          data-property-location={`${property.location.sector}, ${property.location.city}`}
          class="card-save"
          aria-label="Guardar"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
          </svg>
        </button>
      </div>
    </div>
  </a>
</article>

<script>
  // Carousel functionality
  document.addEventListener('DOMContentLoaded', () => {
    initPropertyCarousels();
  });

  document.addEventListener('astro:page-load', () => {
    initPropertyCarousels();
  });

  function initPropertyCarousels() {
    const carousels = document.querySelectorAll('[data-carousel]');

    carousels.forEach((carousel) => {
      const cardId = carousel.getAttribute('data-carousel');
      if (!cardId) return;

      const slides = carousel.querySelectorAll('.card-slide') as NodeListOf<HTMLElement>;
      const prevBtn = document.querySelector(`[data-carousel-prev="${cardId}"]`);
      const nextBtn = document.querySelector(`[data-carousel-next="${cardId}"]`);
      const segments = document.querySelectorAll(`[data-carousel-dot="${cardId}"]`);

      if (slides.length <= 1) return;

      let currentIndex = 0;

      function goToSlide(index: number) {
        if (index >= slides.length) index = 0;
        if (index < 0) index = slides.length - 1;

        slides.forEach((slide, i) => {
          slide.classList.toggle('active', i === index);
        });

        segments.forEach((seg, i) => {
          seg.classList.toggle('active', i === index);
        });

        currentIndex = index;
      }

      prevBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        goToSlide(currentIndex - 1);
      });

      nextBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        goToSlide(currentIndex + 1);
      });

      segments.forEach((seg) => {
        seg.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const index = parseInt(seg.getAttribute('data-dot-index') || '0');
          goToSlide(index);
        });
      });
    });
  }
</script>

<style>
  .card-property {
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
    transition: box-shadow 0.2s, transform 0.2s;
  }

  .card-property:hover {
    box-shadow: 0 8px 24px -8px rgba(0,0,0,0.12);
    transform: translateY(-2px);
  }

  /* Image Section */
  .card-image-wrap {
    position: relative;
    aspect-ratio: 16/10;
    background: #f3f4f6;
    overflow: hidden;
  }

  /* Main image - always visible */
  .card-main-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* Carousel overlay for multiple images */
  .card-carousel {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2;
  }

  .card-carousel .card-slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.3s ease;
    display: block;
  }

  .card-carousel .card-slide.active {
    opacity: 1;
  }

  .card-slide[src=""],
  .card-slide:not([src]) {
    background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
  }

  /* Progress bar style indicators */
  .card-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    gap: 2px;
    padding: 8px;
    background: linear-gradient(transparent, rgba(0,0,0,0.3));
    z-index: 5;
  }

  .progress-segment {
    flex: 1;
    height: 2px;
    background: rgba(255,255,255,0.4);
    border-radius: 1px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .progress-segment.active {
    background: #fff;
  }

  /* Navigation Arrows */
  .card-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s, background 0.2s;
    z-index: 10;
  }

  .card-nav svg {
    width: 16px;
    height: 16px;
    color: #374151;
  }

  .card-nav-prev { left: 8px; }
  .card-nav-next { right: 8px; }

  .card-image-wrap:hover .card-nav {
    opacity: 1;
  }

  .card-nav:hover {
    background: #fff;
  }

  /* Content Section */
  .card-content {
    padding: 12px 14px 14px;
  }

  .card-price-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }

  .card-price {
    font-size: 1.25rem;
    font-weight: 700;
    color: #111827;
    letter-spacing: -0.02em;
  }

  .price-period {
    font-size: 0.875rem;
    font-weight: 400;
    color: #6b7280;
  }

  .card-tag {
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 2px 6px;
    border-radius: 3px;
  }

  .card-tag.rent {
    background: #E8DFD0;  /* Ubikala sand-light (reference) */
    color: #5C6B3C;       /* Ubikala olive (reference) */
  }

  .card-tag.reduced {
    background: #fee2e2;
    color: #dc2626;
  }

  .card-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: #1f2937;
    line-height: 1.3;
    margin-bottom: 4px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-property:hover .card-title {
    color: #5C6B3C;  /* Ubikala olive (reference) */
  }

  .card-location {
    font-size: 0.8125rem;
    color: #6b7280;
    margin-bottom: 8px;
  }

  .card-features {
    font-size: 0.8125rem;
    color: #4b5563;
    font-weight: 500;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f3f4f6;
  }

  .card-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .card-type {
    font-size: 0.75rem;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    font-weight: 500;
  }

  /* Save button - Bookmark style */
  .card-save {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    background: transparent;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.15s;
  }

  .card-save svg {
    width: 18px;
    height: 18px;
    color: #9ca3af;
    transition: color 0.15s;
  }

  .card-save:hover {
    background: #f3f4f6;
  }

  .card-save:hover svg {
    color: #5C6B3C;  /* Ubikala olive (reference) */
  }

  .card-save.is-favorite svg {
    fill: #C96D3D;   /* Ubikala terracotta (reference) */
    color: #C96D3D;  /* Ubikala terracotta (reference) */
  }

  /* Agent overlay on image */
  .card-agent-overlay {
    position: absolute;
    top: 8px;
    left: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px 4px 4px;
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(4px);
    border-radius: 16px;
    z-index: 15;
    text-decoration: none;
    transition: background 0.2s;
    max-width: calc(100% - 16px);
  }

  .card-agent-overlay:hover {
    background: #fff;
  }

  .agent-avatar-wrap {
    position: relative;
    flex-shrink: 0;
  }

  .agent-avatar {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    object-fit: cover;
    display: block;
  }

  .agent-badge {
    position: absolute;
    bottom: -2px;
    right: -2px;
    width: 10px;
    height: 10px;
    color: #5C6B3C;  /* Ubikala olive (reference) */
    background: #fff;
    border-radius: 50%;
  }

  .agent-name {
    font-size: 0.6875rem;
    font-weight: 500;
    color: #1f2937;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 160px;
  }

  .agent-company {
    font-size: 0.5625rem;
    color: #6b7280;
    font-weight: 400;
  }
</style>
